<!doctype html>
<html lang="fr">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="manifest" href="manifest.json">
        <meta name="theme-color" content="#27ae60">
        <link rel="icon" href="images/icon-192.png" type="image/png">
        <link rel="icon" href="images/icon-192.svg" type="image/svg+xml">
        <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
        <link rel="mask-icon" href="images/icon-192.svg" color="#27ae60">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/L.Control.Locate.min.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/MarkerCluster.css">
        <link rel="stylesheet" href="css/MarkerCluster.Default.css">
        <link rel="stylesheet" href="css/leaflet-search.css">
        <link rel="stylesheet" href="css/leaflet.photon.css">
        <link rel="stylesheet" href="css/leaflet-measure.css">
        <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }

        body.modal-open {
            overflow: hidden !important;
        }

        /* Navigation Bar */
        .navbar {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 50%, #229954 100%);
            color: white;
            padding: 0;
            box-shadow: 0 4px 16px rgba(46, 204, 113, 0.35);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 3px solid rgba(255,255,255,0.1);
        }

        .navbar-brand {
            padding: 0 20px;
            font-weight: 700;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: 0.5px;
        }

        .navbar-brand i {
            font-size: 26px;
        }

        .navbar-menu {
            display: flex;
            list-style: none;
            gap: 0;
            flex: 1;
            margin-left: 40px;
        }

        .navbar-menu li {
            position: relative;
        }

        .navbar-menu a {
            color: white;
            text-decoration: none;
            padding: 20px 16px;
            display: block;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .navbar-menu a:hover {
            background: rgba(255,255,255,0.2);
        }

        .dropdown {
            position: relative;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            color: #333;
            list-style: none;
            min-width: 200px;
            box-shadow: 0 6px 16px rgba(46, 204, 113, 0.2);
            border-radius: 6px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1001;
            margin-top: 0;
            border-top: 3px solid #27ae60;
        }

        .dropdown:hover .dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-menu li a {
            padding: 12px 16px;
            color: #333;
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.2s ease;
        }

        .dropdown-menu li:last-child a {
            border-bottom: none;
        }

        .dropdown-menu li a:hover {
            background: #f0fdf4;
            color: #27ae60;
            padding-left: 20px;
            font-weight: 500;
        }

        .navbar-right {
            padding-right: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .navbar-btn {
            background: rgba(255,255,255,0.15);
            border: 1.5px solid rgba(255,255,255,0.4);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .navbar-btn:hover {
            background: rgba(255,255,255,0.25);
            border-color: rgba(255,255,255,0.6);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Main Container */
        .container {
            display: flex;
            height: calc(100% - 60px);
            margin-top: 0;
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 0;
        }

        /* Left Sidebar - Layers */
        .sidebar-left {
            width: 320px;
            height: 100%;
            background: linear-gradient(180deg, #f8fafb 0%, #ffffff 100%);
            box-shadow: 2px 0 12px rgba(46, 204, 113, 0.15);
            overflow-y: auto;
            position: relative;
            z-index: 100;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            border-right: 2px solid #e8f5e9;
        }

        .sidebar-left.collapsed {
            width: 0;
            overflow: hidden;
        }

        .sidebar-header {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 50%, #229954 100%);
            color: white;
            padding: 18px 16px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(46, 204, 113, 0.25);
            font-size: 15px;
            letter-spacing: 0.5px;
        }

        .sidebar-header i {
            margin-right: 8px;
        }

        .sidebar-content {
            padding: 12px;
            overflow-y: auto;
            flex: 1;
        }

        .toggle-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            cursor: pointer;
            font-size: 18px;
            padding: 6px 10px;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toggle-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        /* Map Container */
        #map {
            flex: 1;
            position: relative;
            background: #e8e8e8;
        }

        /* Right Sidebar - Basemaps and Legend */
        .sidebar-right {
            width: 300px;
            height: 100%;
            background: linear-gradient(180deg, #f8fafb 0%, #ffffff 100%);
            box-shadow: -2px 0 12px rgba(46, 204, 113, 0.15);
            overflow: hidden;
            position: relative;
            z-index: 100;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            border-left: 2px solid #e8f5e9;
        }

        .sidebar-right.collapsed {
            width: 0;
            overflow: hidden;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 2px solid #e8f5e9;
            background: linear-gradient(90deg, rgba(46, 204, 113, 0.08) 0%, rgba(39, 174, 96, 0.08) 100%);
            flex-shrink: 0;
        }

        .tab {
            flex: 1;
            background: transparent;
            color: #555;
            border: none;
            padding: 14px 12px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .tab:hover {
            background: rgba(46, 204, 113, 0.08);
            color: #27ae60;
        }

        .tab.active {
            background: white;
            color: #27ae60;
            border-bottom-color: #27ae60;
            font-weight: 600;
            box-shadow: 0 2px 6px rgba(46, 204, 113, 0.1);
        }

        .tab-content {
            display: none;
            padding: 12px;
            overflow-y: auto;
            flex: 1;
            max-height: calc(100vh - 300px);
            height: 100%;
        }

        .tab-content.active {
            display: block;
        }

        /* Basemaps */
        .basemap-option {
            padding: 10px;
            margin-bottom: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .basemap-option:hover {
            border-color: #27ae60;
            background: #f0fdf4;
        }

        .basemap-option input[type="radio"] {
            cursor: pointer;
            accent-color: #27ae60;
        }

        /* Legend */
        .legend-panel { background: linear-gradient(180deg,#ffffff, #fbfffb); border-radius: 10px; padding: 8px; box-shadow: 0 6px 24px rgba(12, 74, 26, 0.06); }
        .legend-header { display:flex; align-items:center; gap:8px; justify-content:space-between; padding: 6px 4px 10px 4px; }
        .legend-title { font-weight:700; color:#235b30; font-size:14px; display:flex; align-items:center; gap:8px; }
        .legend-actions { display:flex; align-items:center; gap:6px; }
        .legend-search { padding:8px 10px; border-radius:8px; border:1px solid #e6f0ea; min-width:160px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .legend-pin.active { background:#27ae60; color:#fff; }
        .legend-collapse { transition: transform 180ms ease; }
        .legend-items { margin-top:8px; max-height: 48vh; overflow:auto; padding-right:4px; }

        .legend-item { display:flex; align-items:center; gap:10px; padding:10px; margin-bottom:8px; font-size:13px; border-radius:8px; transition: all 180ms ease; background: #fff; border: 1px solid #e8f2eb; }
        .legend-item:hover { transform: translateY(-3px); box-shadow: 0 6px 18px rgba(39,174,96,0.06); }
        .legend-item .legend-left { display:flex; align-items:center; gap:8px; flex-shrink:0; }
        .legend-item .legend-main { flex:1; display:flex; flex-direction:column; gap:4px; }
        .legend-item .legend-meta { font-size:12px; color:#6b705c; }
        .legend-item .legend-actions-item { margin-left:8px; display:flex; gap:6px; }
        .legend-item .info-btn { background:transparent; border:none; color:#27ae60; cursor:pointer; padding:6px; border-radius:6px; }
        .legend-item .info-btn:hover { background:rgba(39,174,96,0.08); }

        .legend-empty { padding:12px; color:#666; text-align:center; }

        /* Search suggestions (navbar) */
        .nav-search { position:relative; }
        .nav-search input { width:220px; padding:8px 12px; border-radius:8px; border:1px solid #e6f0ea; box-shadow:0 2px 8px rgba(0,0,0,0.04); }
        .search-suggestions { position:absolute; left:0; right:0; top:110%; background:white; border-radius:8px; box-shadow: 0 8px 24px rgba(12,74,26,0.08); max-height:320px; overflow:auto; z-index:1200; }
        .search-suggestions .item { padding:8px 12px; border-bottom:1px solid #f0f3f0; cursor:pointer; display:flex; align-items:center; gap:8px; }
        .search-suggestions .item:hover, .search-suggestions .item.active { background:#f0fff4; }
        .search-suggestions .type { font-size:11px; color:#4a6b4a; border-radius: 6px; padding:2px 6px; border:1px solid #eaf6ec; }

        /* Floating legend quick button */
        #openLegendBtn { position: absolute; bottom:20px; right:18px; z-index:700; width:44px; height:44px; border-radius:8px; display:flex; align-items:center; justify-content:center; background:#fff; color:#27ae60; border:1px solid rgba(39,174,96,0.12); box-shadow: 0 6px 20px rgba(39,174,96,0.06); }
        #openLegendBtn:hover { transform:translateY(-3px); }

        /* Responsive tweaks */
        @media (max-width: 768px) {
            .nav-search input { width: 90vw; max-width:240px; }
            .legend-items { max-height: 40vh; }
            #openLegendBtn { right:16px; bottom:16px; }
        }

        /* Coordinates Panel */
        .coords-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 12px 16px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            font-size: 12px;
            z-index: 500;
            font-family: 'Courier New', monospace;
        }

        .coords-panel span {
            display: block;
            margin: 4px 0;
        }

        .coords-label {
            font-weight: bold;
            color: #667eea;
        }

        /* Scale Control */
        .scale-panel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 12px 16px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 500;
            text-align: center;
            font-size: 12px;
        }

        /* Leaflet overrides */
        .leaflet-control-layers {
            display: none !important;
        }
        .leaflet-control-measure {
            position: fixed;
            bottom: 20px;
            right: 20px;
            margin-right: 320px;
            z-index: 600;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            box-shadow: 0 4px 12px rgba(207, 42, 42, 0.4);
            border-radius: 8px;
            overflow: hidden;
        }

        .leaflet-control-measure button {
            background: linear-gradient(135deg, #ee5a6f 0%, #c92a2a 100%);
            border: none;
            color: white !important;
            font-weight: bold;
            padding: 10px 12px;
            transition: all 0.3s ease;
        }

        .leaflet-control-measure button:hover {
            background: linear-gradient(135deg, #c92a2a 0%, #a91f1f 100%);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(169, 31, 31, 0.6);

        }

        .nav-green-measure, .nav-green-download {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%) !important;
            font-weight: 600;
            border-radius: 4px;
            margin: 8px 4px;
            padding: 20px 14px !important;
            box-shadow: 0 2px 6px rgba(46, 204, 113, 0.3);
            transition: all 0.3s ease;
        }

        .nav-green-measure:hover, .nav-green-download:hover {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%) !important;
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.6);
            transform: translateY(-2px);
        }

        .leaflet-control-locate {
            position: fixed;
            bottom: 20px;
            right: 20px;
            margin-right: 280px;
            z-index: 600;
        }

        .leaflet-control-zoom {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 600;
        }

        .leaflet-photon {
            z-index: 1000 !important;
            position: fixed !important;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
        }

        .leaflet-photon input {
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .leaflet-photon input:focus {
            outline: none;
            border-color: #27ae60;
            box-shadow: 0 0 4px rgba(39, 174, 96, 0.3);
        }

        /* Scrollbar styling */
        .sidebar-left::-webkit-scrollbar,
        .sidebar-right::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-left::-webkit-scrollbar-track,
        .sidebar-right::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .sidebar-left::-webkit-scrollbar-thumb,
        .sidebar-right::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .sidebar-left::-webkit-scrollbar-thumb:hover,
        .sidebar-right::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Layer tree styling */
        .leaflet-control-layers-tree {
            max-width: 100%;
            box-shadow: none !important;
            border: none !important;
            background: transparent !important;
        }

        /* Modal styles */
        .modal, .custom-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .modal.active, .custom-modal.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: white;
            margin: auto;
            padding: 0;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: visible;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0;
            border-bottom: 2px solid #e0e0e0;
            padding: 20px 30px;
            flex-shrink: 0;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        /* Modal content scrollable area */
        .modal-body {
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px;
            flex: 1;
            -webkit-overflow-scrolling: touch;
        }

        /* Modal footer fixed */
        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #ddd;
            background: white;
            flex-shrink: 0;
            text-align: center;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .navbar-menu {
                margin-left: 0;
            }

            .sidebar-left,
            .sidebar-right {
                position: absolute;
                height: calc(100% - 60px);
                z-index: 500;
            }

            .sidebar-left {
                left: 0;
            }

            .sidebar-right {
                right: 0;
            }
        }

        /* Styles pour les labels permanents */
        .leaflet-tooltip {
            background: transparent;
            border: none;
            box-shadow: none;
        }

        .leaflet-tooltip-pane {
            z-index: 650 !important;
        }

        .leaflet-tooltip.leaflet-tooltip-bottom::before {
            border-bottom-color: rgba(255,255,255,0.7);
        }

        /* CSS pour les tooltips des r√©gions */
        .css_Region_2.leaflet-tooltip {
            background: transparent;
            border: none;
        }

        /* CSS pour les tooltips des arrondissements */
        .css_Arrondissement_3.leaflet-tooltip {
            background: transparent;
            border: none;
        }

        /* Search Container Styling - Now in sidebar */
        .search-section {
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.05) 0%, rgba(39, 174, 96, 0.05) 100%);
            padding: 14px;
            border-radius: 10px;
            border: 1.5px solid rgba(46, 204, 113, 0.15);
            margin-bottom: 16px;
        }

        .search-label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            color: #27ae60;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .search-label i {
            font-size: 14px;
        }

        .search-box {
            margin-bottom: 10px;
        }

        .search-box:last-child {
            margin-bottom: 0;
        }

        #photonContainer,
        #localitiesSearchContainer {
            width: 100%;
        }

        #photonContainer .leaflet-control-photon {
            width: 100% !important;
            margin: 0 !important;
            border: 1.5px solid #ddd;
            border-radius: 8px;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        #photonContainer input,
        #localitiesSearchContainer input {
            width: 100%;
            padding: 10px 14px;
            border: 1.5px solid #ddd;
            border-radius: 8px;
            font-size: 13px;
            background: white;
            transition: all 0.3s ease;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        #photonContainer input::placeholder,
        #localitiesSearchContainer input::placeholder {
            color: #999;
            font-style: italic;
        }

        #photonContainer input:focus,
        #localitiesSearchContainer input:focus {
            outline: none;
            border-color: #27ae60;
            box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.15);
            background: #f9fff9;
        }

        .leaflet-control-search {
            margin: 0 !important;
            background: white !important;
            box-shadow: none !important;
            width: 100% !important;
            border: none !important;
        }

        .leaflet-control-search input {
            border-radius: 8px !important;
            border: 1.5px solid #ddd !important;
            padding: 10px 14px !important;
            font-size: 13px !important;
            transition: all 0.3s ease !important;
        }

        .leaflet-control-search input:focus {
            border-color: #27ae60 !important;
            box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.15) !important;
        }

        .leaflet-control-search .search-button {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%) !important;
            color: white !important;
            border: none !important;
            cursor: pointer;
            padding: 8px 12px !important;
            border-radius: 6px !important;
            transition: all 0.3s ease !important;
            font-size: 12px !important;
            margin: 2px !important;
            font-weight: 500 !important;
        }

        .leaflet-control-search .search-button:hover {
            background: linear-gradient(135deg, #229954 0%, #1e8449 100%) !important;
            box-shadow: 0 2px 6px rgba(46, 204, 113, 0.3) !important;
            transform: translateY(-1px) !important;
        }

        /* Quick Search Control - Ic√¥ne lunettes avec dropdown */
        .leaflet-control-quicksearch {
            background: none;
            border: none;
            padding: 0;
            min-width: 0;
            box-shadow: none;
            width: auto;
        }

        .quicksearch-container {
            position: relative;
            width: 48px;
        }

        .quicksearch-toggle-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            border: none;
            color: white;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .quicksearch-toggle-icon:hover {
            background: linear-gradient(135deg, #229954 0%, #1e8449 100%);
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.4);
            transform: scale(1.1);
        }

        .quicksearch-dropdown {
            display: none;
            position: absolute;
            top: 60px;
            left: 0;
            width: 340px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            z-index: 1000;
            overflow: hidden;
            animation: slideDown 0.3s ease;
            flex-direction: column;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .quicksearch-dropdown.active {
            display: flex;
        }

        .quicksearch-header {
            padding: 12px;
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            font-weight: bold;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quicksearch-inputs {
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .quicksearch-input {
            width: 100%;
            padding: 10px 12px;
            border: 1.5px solid #e0e0e0;
            border-radius: 6px;
            font-size: 12px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: all 0.2s ease;
            box-sizing: border-box;
        }

        .quicksearch-input:focus {
            outline: none;
            border-color: #27ae60;
            box-shadow: 0 0 8px rgba(46, 204, 113, 0.3);
            background: #f9fff9;
        }

        .quicksearch-input::placeholder {
            color: #999;
        }

        .quicksearch-buttons {
            padding: 10px 12px;
            display: flex;
            gap: 8px;
            border-top: 1px solid #e0e0e0;
            background: #f9f9f9;
        }

        .quicksearch-btn {
            flex: 1;
            padding: 10px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .quicksearch-search-btn {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
        }

        .quicksearch-search-btn:hover {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            box-shadow: 0 2px 8px rgba(46, 204, 113, 0.3);
        }

        .quicksearch-clear-btn {
            background: #f0f0f0;
            color: #666;
        }

        .quicksearch-clear-btn:hover {
            background: #e0e0e0;
        }

        /* Smart Search Control */
        .leaflet-control-smartsearch {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            padding: 0;
            min-width: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .smartsearch-toggle {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            border: none;
            color: white;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            border-radius: 8px;
        }

        .smartsearch-toggle:hover {
            background: linear-gradient(135deg, #229954 0%, #1e8449 100%);
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.4);
            transform: scale(1.05);
        }

        .smartsearch-panel {
            display: none;
            width: 320px;
            max-height: 500px;
            padding: 12px;
            flex-direction: column;
            gap: 10px;
            background: white;
        }

        .smartsearch-panel.active {
            display: flex;
        }

        .smartsearch-search {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f5f5f5;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1.5px solid #e0e0e0;
        }

        .smartsearch-search input {
            flex: 1;
            background: none;
            border: none;
            outline: none;
            font-size: 13px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .smartsearch-search i {
            color: #27ae60;
            font-size: 14px;
        }

        .smartsearch-results {
            overflow-y: auto;
            max-height: 400px;
            flex: 1;
        }

        .smartsearch-result-item {
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid #ddd;
            font-size: 12px;
            user-select: none;
        }

        .smartsearch-result-item:hover {
            background: #f5f5f5;
            border-left-color: #27ae60;
            padding-left: 14px;
        }

        .smartsearch-result-item.region {
            border-left-color: #e74c3c;
        }

        .smartsearch-result-item.region::before {
            content: "üèõÔ∏è ";
            font-weight: bold;
            color: #e74c3c;
        }

        .smartsearch-result-item.departement {
            border-left-color: #3498db;
        }

        .smartsearch-result-item.departement::before {
            content: "üìç ";
            font-weight: bold;
            color: #3498db;
        }

        .smartsearch-result-item.arrondissement {
            border-left-color: #f39c12;
        }

        .smartsearch-result-item.arrondissement::before {
            content: "üó∫Ô∏è ";
            font-weight: bold;
            color: #f39c12;
        }

        .smartsearch-result-item.localite {
            border-left-color: #16a085;
        }

        .smartsearch-result-item.localite::before {
            content: "üèòÔ∏è ";
            font-weight: bold;
            color: #16a085;
        }

        .smartsearch-no-results {
            padding: 20px;
            text-align: center;
            color: #999;
            font-size: 12px;
        }

        .smartsearch-clear-icon {
            width: 24px;
            height: 24px;
            cursor: pointer;
            color: #999;
            transition: all 0.2s ease;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .smartsearch-clear-icon:hover {
            color: #27ae60;
            transform: scale(1.2);
        }

        .smartsearch-clear-icon.show {
            display: flex;
        }

        /* PWA and g√©olocalisation buttons */
        #geo-btn {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            display:flex;
            align-items:center;
            justify-content:center;
            background: #fff;
            color: #27ae60;
            border: 1px solid rgba(39,174,96,0.15);
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
            cursor: pointer;
        }
        #geo-btn.active {
            background: #27ae60;
            color: #fff;
        }
        #install-btn {
            display: none;
            background: #fff;
            color: #27ae60;
        }

        /* Responsive mobile styles */
        @media (max-width: 768px) {
            .navbar { height: 56px; padding: 0 12px; }
            .navbar-brand span { font-size: 16px; }
            .navbar-menu { position: fixed; top: 56px; left: 0; right: 0; background: #fff; z-index: 1100; max-height: 0; overflow: hidden; flex-direction: column; box-shadow: 0 6px 20px rgba(0,0,0,0.15); transform: translateY(-8px); opacity: 0; transition: max-height 300ms ease, transform 240ms cubic-bezier(.2,.8,.2,1), opacity 240ms ease; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; }
            .navbar-menu a { padding: 14px 16px; border-bottom: 1px solid #f0f0f0; color: #333; }
            .navbar-menu.mobile-open { max-height: 60vh; transform: translateY(0); opacity: 1; }
            .navbar-menu li.mobile-close { display:flex; justify-content:flex-end; padding: 8px 12px; border-bottom: 1px solid #eee; }
            .mobile-only { display: inline-flex; }
            .navbar-right .navbar-btn { padding: 8px; font-size: 12px; }

            /* Sidebars collapses on mobile */
            .sidebar-left, .sidebar-right { position: fixed; top: 56px; bottom: 0; width: 0; overflow: hidden; transition: width 0.25s ease; z-index: 100; }
            .sidebar-left { left: 0; }
            .sidebar-right { right: 0; }
            .sidebar-left.collapsed, .sidebar-right.collapsed { width: 0; }
            .sidebar-left:not(.collapsed) { width: 280px; }
            .sidebar-right:not(.collapsed) { width: 260px; }

            .container { top: 56px; height: calc(100% - 56px); }
            #map { height: 100%; }

            #geo-btn { bottom: 80px; left: auto; right: 16px; }
            #install-btn { right: 16px; display: inline-flex; }
        }

        /* Desktop: hide mobile-only */
        @media (min-width: 769px) {
            .mobile-only { display: none; }
        }
        </style>
        <title>SIG - Cartographie administrative du S√©n√©gal</title>
    </head>
    <body>
        <!-- Navigation Bar -->
        <nav class="navbar">
            <div class="navbar-brand">
                <i class="fas fa-globe"></i>
                <span>SIG S√©n√©gal</span>
            </div>
            <button id="mobile-menu-btn" class="navbar-btn mobile-only" onclick="toggleMobileMenu()" aria-label="Ouvrir le menu">
                <i class="fas fa-bars"></i>
            </button>
            <ul class="navbar-menu" id="navbarMenu" aria-hidden="true">
                <li class="mobile-close" style="display:none; padding:8px 12px; justify-content:flex-end;">
                    <button id="mobile-menu-close" class="navbar-btn" onclick="toggleMobileMenu()" aria-label="Fermer le menu"><i class="fas fa-times"></i></button>
                </li>
                <li><a href="#" onclick="showModal('accueil'); return false;"><i class="fas fa-home"></i> Accueil</a></li>
                <li class="dropdown">
                    <a href="#"><i class="fas fa-search"></i> Requ√™tes</a>
                    <ul class="dropdown-menu">
                        <li><a href="#" onclick="activateSpatialQuery(); return false;">Requ√™te spatiale</a></li>
                        <li><a href="#" onclick="activateAttributeQuery(); return false;">Requ√™te attributaire</a></li>
                    </ul>
                </li>
                <li><a href="#" onclick="activateMeasureTool(); return false;" class="nav-green-measure"><i class="fas fa-ruler-combined"></i> Mesure</a></li>
                <li><a href="#" onclick="downloadData(); return false;" class="nav-green-download"><i class="fas fa-download"></i> T√©l√©charger</a></li>
                <li><a href="#" onclick="showModal('apropos'); return false;"><i class="fas fa-info-circle"></i> √Ä propos</a></li>
            </ul>
            <div class="navbar-right">
                <button class="navbar-btn" onclick="toggleLeftSidebar()">
                    <i class="fas fa-layer-group"></i> Couches
                </button>
                <button class="navbar-btn" onclick="toggleRightSidebar()">
                    <i class="fas fa-sliders-h"></i> Fonds
                </button>
                <button id="install-btn" class="navbar-btn" onclick="promptInstall()" style="display:none;">
                    <i class="fas fa-download"></i> Installer
                </button>
            </div>
        </nav>

        <!-- Main Container -->
        <div class="container">
            <!-- Left Sidebar -->
            <div class="sidebar-left" id="sidebarLeft">
                <div class="sidebar-header">
                    <span><i class="fas fa-layer-group"></i> Couches</span>
                    <button class="toggle-btn" onclick="toggleLeftSidebar()">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                </div>
                <div class="sidebar-content" id="layersContainer">
                </div>
            </div>

            <!-- Map -->
            <div id="map"></div>

            <!-- Right Sidebar -->
            <div class="sidebar-right" id="sidebarRight">
                <div class="tabs">
                    <button class="tab" onclick="switchTab(event, 'basemaps')">
                        <i class="fas fa-image"></i> Fonds
                    </button>
                    <button class="tab active" onclick="switchTab(event, 'legend')">
                        <i class="fas fa-book"></i> L√©gende
                    </button>
                </div>

                <!-- Basemaps Tab -->
                <div id="basemaps" class="tab-content">
                    <div style="padding: 8px;">
                        <div class="basemap-option">
                            <input type="radio" name="basemap" value="cartodb" checked onchange="changeBasemap('cartodb')">
                            <label>CartoDB Dark</label>
                        </div>
                        <div class="basemap-option">
                            <input type="radio" name="basemap" value="satellite" onchange="changeBasemap('satellite')">
                            <label>Google Satellite</label>
                        </div>
                        <div class="basemap-option">
                            <input type="radio" name="basemap" value="openstreet" onchange="changeBasemap('openstreet')">
                            <label>OpenStreetMap</label>
                        </div>
                    </div>
                </div>

                <!-- Legend Tab -->
                <div id="legend" class="tab-content active">
                    <div style="padding: 8px;" id="legendContent">
                        <div class="legend-panel">
                            <div class="legend-header">
                                <div class="legend-title"><i class="fas fa-book"></i> L√©gende</div>
                                <div class="legend-actions">
                                    <input id="legendSearch" class="legend-search" placeholder="Filtrer la l√©gende..." aria-label="Filtrer la l√©gende">
                                    <button id="legendPinBtn" class="navbar-btn legend-pin" title="√âpingler la l√©gende"><i class="fas fa-thumbtack"></i></button>
                                    <button id="legendCollapseBtn" class="navbar-btn legend-collapse" title="R√©duire/Agrandir"><i class="fas fa-chevron-up"></i></button>
                                </div>
                            </div>
                            <div id="legendItems" class="legend-items" role="list" aria-label="√âl√©ments de la l√©gende">
                                <!-- items injected JS -->
                            </div>
                            <div id="legendEmpty" class="legend-empty" style="display:none;">Aucun √©l√©ment correspondant</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Coordinates Panel -->
        <div class="coords-panel" id="coordsPanel">
            <span class="coords-label">Coordonn√©es GPS</span>
            <span>Lat: <span id="lat">-</span></span>
            <span>Lng: <span id="lng">-</span></span>
            <span>Zoom: <span id="zoom">-</span></span>
        </div>

        <!-- Quick legend button (mobile) -->
        <button id="openLegendBtn" class="navbar-btn" title="L√©gende" aria-label="Ouvrir la l√©gende"><i class="fas fa-book"></i></button>

        <!-- Scale Panel -->
        <div class="scale-panel" id="scalePanel">
            <span id="scaleInfo">√âchelle: 1:50000</span>
        </div>

        <!-- Modals -->
        <div id="accueilModal" class="modal">
            <div class="modal-content" style="background: linear-gradient(135deg, #f0fdf4 0%, #f1fef5 100%);">
                <div class="modal-header" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); color: white;">
                    <h2 class="modal-title" style="color: white; margin: 0;"><i class="fas fa-home"></i> Accueil - Bienvenue dans SIG S√©n√©gal</h2>
                    <button class="close-btn" onclick="closeModal('accueil')" style="color: white; font-size: 28px; margin: 0;">&times;</button>
                </div>
                <div class="modal-body" style="color: #333; line-height: 1.8;">
                    <h3 style="color: #27ae60; margin-bottom: 15px; font-size: 20px;">üìä Syst√®me d'Information G√©ographique du S√©n√©gal</h3>
                    <p style="margin-bottom: 25px; font-size: 15px;">Bienvenue dans l'application de cartographie interactive des limites administratives et donn√©es g√©ographiques du S√©n√©gal. Explorez les r√©gions, d√©partements, arrondissements, routes et hydrographie en temps r√©el.</p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 25px 0; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(46, 204, 113, 0.1);">
                        <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #f0fdf4 0%, #e8f8f0 100%); border-radius: 8px; border-left: 4px solid #2ecc71;">
                            <div style="font-size: 28px; font-weight: bold; color: #27ae60;">14</div>
                            <div style="color: #666; font-size: 13px; margin-top: 8px;">R√©gions</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #f0fdf4 0%, #e8f8f0 100%); border-radius: 8px; border-left: 4px solid #2ecc71;">
                            <div style="font-size: 28px; font-weight: bold; color: #27ae60;">78</div>
                            <div style="color: #666; font-size: 13px; margin-top: 8px;">D√©partements</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #f0fdf4 0%, #e8f8f0 100%); border-radius: 8px; border-left: 4px solid #2ecc71;">
                            <div style="font-size: 28px; font-weight: bold; color: #27ae60;">500+</div>
                            <div style="color: #666; font-size: 13px; margin-top: 8px;">Localit√©s</div>
                        </div>
                    </div>

                    <div style="background: white; padding: 20px; border-radius: 8px; margin: 20px 0; box-shadow: 0 2px 8px rgba(46, 204, 113, 0.1);">
                        <h4 style="color: #27ae60; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-star"></i> Fonctionnalit√©s disponibles
                        </h4>
                        <ul style="margin: 0; padding-left: 20px;">
                            <li style="margin: 8px 0; color: #555;">‚úì Visualisation interactive des couches g√©ographiques</li>
                            <li style="margin: 8px 0; color: #555;">‚úì Clustering automatique des localit√©s pour meilleure performance</li>
                            <li style="margin: 8px 0; color: #555;">‚úì Outils de mesure (distance et surface)</li>
                            <li style="margin: 8px 0; color: #555;">‚úì Localisation GPS en temps r√©el</li>
                            <li style="margin: 8px 0; color: #555;">‚úì T√©l√©chargement des donn√©es en format GeoJSON</li>
                            <li style="margin: 8px 0; color: #555;">‚úì Recherche avanc√©e par coordonn√©es</li>
                            <li style="margin: 8px 0; color: #555;">‚úì Trois fonds de carte au choix</li>
                        </ul>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
                        <div style="background: linear-gradient(135deg, #e8f8f0 0%, #f0fdf4 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #27ae60;">
                            <h5 style="color: #27ae60; margin: 0 0 10px 0;">üìç Navigation</h5>
                            <p style="margin: 0; font-size: 13px; color: #666;">Utilisez les boutons <strong>Couches</strong> et <strong>Fonds</strong> pour personnaliser votre vue.</p>
                        </div>
                        <div style="background: linear-gradient(135deg, #e8f8f0 0%, #f0fdf4 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #27ae60;">
                            <h5 style="color: #27ae60; margin: 0 0 10px 0;">üîß Outils</h5>
                            <p style="margin: 0; font-size: 13px; color: #666;">Mesurez distances et surfaces avec l'outil <strong>Mesurer</strong>.</p>
                        </div>
                    </div>

                    <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, rgba(46, 204, 113, 0.1) 0%, rgba(39, 174, 96, 0.05) 100%); border-radius: 8px; border-left: 4px solid #2ecc71;">
                        <p style="margin: 0; font-size: 12px; color: #666; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-info-circle" style="color: #27ae60;"></i>
                            <strong style="color: #27ae60;">Conseil :</strong> Consultez la barre de navigation pour acc√©der aux fonctionnalit√©s avanc√©es et au t√©l√©chargement des donn√©es.
                        </p>
                    </div>
                </div>
                <div class="modal-footer" style="background: white;">
                    <button onclick="closeModal('accueil')" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); color: white; border: none; padding: 12px 30px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 14px; transition: 0.3s; box-shadow: 0 2px 6px rgba(46, 204, 113, 0.3);" onmouseover="this.style.boxShadow='0 4px 12px rgba(46, 204, 113, 0.6)'" onmouseout="this.style.boxShadow='0 2px 6px rgba(46, 204, 113, 0.3)'">
                        ‚úì Fermer et explorer la carte
                    </button>
                </div>
            </div>
        </div>

        <div id="aproposModal" class="modal">
            <div class="modal-content" style="background: linear-gradient(135deg, #f0fdf4 0%, #f1fef5 100%);">
                <div class="modal-header" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); color: white;">
                    <h2 class="modal-title" style="color: white;">√Ä propos</h2>
                    <button class="close-btn" onclick="closeModal('apropos')" style="color: white; font-size: 24px;">&times;</button>
                </div>
                <div style="color: #666; line-height: 1.8; padding: 30px;">
                    <p><strong style="color: #27ae60; font-size: 16px;">SIG S√©n√©gal - Cartographie Administrative</strong></p>
                    <p style="margin-top: 10px;">Version 2.0 - 2026</p>
                    <p style="margin-top: 15px;"><strong style="color: #27ae60;">Bas√© sur :</strong></p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li><a href="https://qgis.org" target="_blank" style="color: #27ae60; text-decoration: none; font-weight: 500;">QGIS</a> - Syst√®me d'Information G√©ographique</li>
                        <li><a href="https://leafletjs.com" target="_blank" style="color: #27ae60; text-decoration: none; font-weight: 500;">Leaflet.js</a> - Cartographie Web interactive</li>
                    </ul>
                    <p style="margin-top: 15px; font-size: 12px; color: #999;">Donn√©es cartographiques ¬© 2026 - Tous droits r√©serv√©s</p>
                </div>
            </div>
        </div>

        <!-- Scripts -->
        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
        <script>
        // Patch pour supprimer l'avertissement L.Mixin.Events deprecated
        // Remplace silencieusement L.Mixin.Events par L.Evented
        if (typeof L !== 'undefined' && L.Mixin && !L.Mixin.Events) {
            L.Mixin = L.Mixin || {};
            L.Mixin.Events = L.Evented.prototype;
        }
        </script>
        <script src="js/L.Control.Layers.Tree.min.js"></script>
        <script src="js/L.Control.Locate.min.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet.photon.js"></script>
        <script src="js/leaflet-measure.js"></script>
        <script src="js/leaflet.markercluster.js"></script>
        <script src="js/leaflet-search.js"></script>
        <script src="data/Region_2.js"></script>
        <script src="data/Arrondissement_3.js"></script>
        <script src="data/Departement_4.js"></script>
        <script src="data/Routes_5.js"></script>
        <script src="data/Hydrographie_6.js"></script>
        <script src="data/localites_7.js"></script>
        <script>
        // UI Functions
        function toggleLeftSidebar() {
            const sidebar = document.getElementById('sidebarLeft');
            sidebar.classList.toggle('collapsed');
        }

        function toggleRightSidebar() {
            const sidebar = document.getElementById('sidebarRight');
            sidebar.classList.toggle('collapsed');
        }

        function switchTab(e, tabName) {
            // Retirer la classe active de tous les onglets et contenus
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Ajouter la classe active au nouvel onglet et contenu
            const tabContent = document.getElementById(tabName);
            if (tabContent) {
                tabContent.classList.add('active');
            }
            
            if (e && e.target) {
                const btn = e.target.closest('.tab');
                if (btn) {
                    btn.classList.add('active');
                }
            }
        }

        function showModal(modalType) {
            const modal = document.getElementById(modalType + 'Modal');
            if (modal) {
                document.body.classList.add('modal-open');
                modal.style.display = 'flex';
                setTimeout(() => {
                    modal.classList.add('active');
                }, 10);
            }
        }

        function closeModal(modalType) {
            const modal = document.getElementById(modalType + 'Modal');
            if (modal) {
                document.body.classList.remove('modal-open');
                modal.classList.remove('active');
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300);
            }
        }

        window.onclick = function(event) {
            if (event.target.classList && (event.target.classList.contains('modal') || event.target.classList.contains('custom-modal'))) {
                event.target.style.display = 'none';
                event.target.classList.remove('active');
                document.body.classList.remove('modal-open');
            }
        }

        function changeBasemap(type) {
            if (type === 'cartodb') {
                if (map.hasLayer(layer_GoogleSatelliteHybrid_1)) map.removeLayer(layer_GoogleSatelliteHybrid_1);
                if (map.hasLayer(layer_OSM)) map.removeLayer(layer_OSM);
                if (!map.hasLayer(layer_CartoDbDarkMatter_0)) map.addLayer(layer_CartoDbDarkMatter_0);
            } else if (type === 'satellite') {
                if (map.hasLayer(layer_CartoDbDarkMatter_0)) map.removeLayer(layer_CartoDbDarkMatter_0);
                if (map.hasLayer(layer_OSM)) map.removeLayer(layer_OSM);
                if (!map.hasLayer(layer_GoogleSatelliteHybrid_1)) map.addLayer(layer_GoogleSatelliteHybrid_1);
            } else if (type === 'openstreet') {
                if (map.hasLayer(layer_CartoDbDarkMatter_0)) map.removeLayer(layer_CartoDbDarkMatter_0);
                if (map.hasLayer(layer_GoogleSatelliteHybrid_1)) map.removeLayer(layer_GoogleSatelliteHybrid_1);
                if (!map.hasLayer(layer_OSM)) map.addLayer(layer_OSM);
            }
        }

        function activateMeasureTool() {
            showMeasureModal();
        }

        function showMeasureModal() {
            const modal = document.createElement('div');
            modal.className = 'custom-modal';
            modal.innerHTML = `
                <div class="modal-content" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); border-radius: 12px; border: 2px solid #229954;">
                    <div style="color: white; padding: 30px; text-align: center;">
                        <h2 style="margin-bottom: 20px;"><i class="fas fa-ruler-combined" style="color: #fff;"></i> Outil de Mesure</h2>
                        <p style="font-size: 16px; margin-bottom: 15px;">üìè <strong>L'outil de mesure est activ√© !</strong></p>
                        <p style="font-size: 14px; margin-bottom: 20px;">Cliquez sur la carte pour tracer une ligne et mesurer la distance. Double-cliquez pour terminer.</p>
                        <div style="background: rgba(0,0,0,0.15); padding: 15px; border-radius: 6px; margin-bottom: 20px; text-align: left; font-size: 13px;">
                            <strong>üìè Instructions :</strong>
                            <ul style="margin: 10px 0 0 20px;">
                                <li>Cliquez pour commencer la mesure</li>
                                <li>Continuez √† cliquer pour ajouter des points</li>
                                <li>Double-cliquez pour terminer</li>
                                <li>R√©sultat affich√© en bas √† droite</li>
                            </ul>
                        </div>
                        <button onclick="activateMeasureMode(); document.querySelectorAll('.custom-modal').forEach(m => m.remove());" style="background: white; color: #27ae60; border: none; padding: 12px 24px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-right: 10px;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='white'">‚úÖ Commencer √† mesurer</button>
                        <button onclick="document.querySelectorAll('.custom-modal').forEach(m => m.remove());" style="background: rgba(255,255,255,0.3); color: white; border: 2px solid white; padding: 10px 24px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.5)'" onmouseout="this.style.background='rgba(255,255,255,0.3)'">Fermer</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            setTimeout(() => {
                modal.classList.add('active');
            }, 10);
        }

        // Activate measurement mode
        function activateMeasureMode() {
            try {
                // Chercher le bouton de mesure Leaflet
                const measureButtons = document.querySelectorAll('.leaflet-control-measure-toggle');
                if (measureButtons && measureButtons.length > 0) {
                    measureButtons[0].click();
                    console.log('Mode mesure activ√© via bouton Leaflet');
                } else {
                    alert('‚úÖ L\'outil de mesure est maintenant actif !\n\nCliquez sur la carte pour tracer une ligne et mesurer la distance.\n\nDouble-cliquez pour terminer.');
                }
            } catch(e) {
                console.warn('Impossible d\'activer le mode mesure:', e);
                alert('‚úÖ L\'outil de mesure est maintenant actif !\n\nCliquez sur la carte pour tracer une ligne et mesurer la distance.');
            }
        }

        // Requ√™te Spatiale
        var spatialQueryMode = false;
        function activateSpatialQuery() {
            spatialQueryMode = !spatialQueryMode;
            
            if (spatialQueryMode) {
                showSpatialQueryModal();
                map.dragging.disable();
                document.body.style.cursor = 'crosshair';
                
                map.on('click', performSpatialQuery);
            } else {
                map.dragging.enable();
                document.body.style.cursor = 'grab';
                map.off('click', performSpatialQuery);
            }
        }

        function performSpatialQuery(e) {
            var clickedPoint = e.latlng;
            var results = [];
            var foundLayers = [];

            // V√©rifier les R√©gions
            if (window.layer_Region_2) {
                window.layer_Region_2.eachLayer(function(layer) {
                    if (layer.feature && layer.feature.geometry) {
                        if (pointInPolygon(clickedPoint, layer.feature.geometry.coordinates[0])) {
                            results.push({
                                type: 'R√©gion',
                                name: layer.feature.properties['R√©gion'],
                                properties: layer.feature.properties,
                                layer: layer
                            });
                            foundLayers.push(layer);
                        }
                    }
                });
            }

            // V√©rifier les D√©partements
            if (window.layer_Departement_4) {
                window.layer_Departement_4.eachLayer(function(layer) {
                    if (layer.feature && layer.feature.geometry) {
                        if (pointInPolygon(clickedPoint, layer.feature.geometry.coordinates[0])) {
                            results.push({
                                type: 'D√©partement',
                                name: layer.feature.properties['Dept'],
                                properties: layer.feature.properties,
                                layer: layer
                            });
                            foundLayers.push(layer);
                        }
                    }
                });
            }

            // V√©rifier les Arrondissements
            if (window.layer_Arrondissement_3) {
                window.layer_Arrondissement_3.eachLayer(function(layer) {
                    if (layer.feature && layer.feature.geometry) {
                        if (pointInPolygon(clickedPoint, layer.feature.geometry.coordinates[0])) {
                            results.push({
                                type: 'Arrondissement',
                                name: layer.feature.properties['dept'],
                                properties: layer.feature.properties,
                                layer: layer
                            });
                            foundLayers.push(layer);
                        }
                    }
                });
            }

            // V√©rifier les Localit√©s
            if (window.layer_localites_7) {
                window.layer_localites_7.eachLayer(function(layer) {
                    if (layer.feature && layer.feature.geometry) {
                        var dist = map.distance(clickedPoint, L.latLng(layer.feature.geometry.coordinates[1], layer.feature.geometry.coordinates[0]));
                        if (dist < 5000) { // 5km de rayon
                            results.push({
                                type: 'Localit√©',
                                name: layer.feature.properties['NOM'],
                                properties: layer.feature.properties,
                                distance: dist,
                                layer: layer
                            });
                            foundLayers.push(layer);
                        }
                    }
                });
            }

            showSpatialQueryResults(results, clickedPoint, foundLayers);
        }

        function pointInPolygon(point, polygon) {
            var lat = point.lat;
            var lng = point.lng;
            var inside = false;

            for (var i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                var xi = polygon[i][0], yi = polygon[i][1];
                var xj = polygon[j][0], yj = polygon[j][1];

                var intersect = ((yi > lat) !== (yj > lat))
                    && (lng < (xj - xi) * (lat - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }

            return inside;
        }

        function showSpatialQueryModal() {
            const modal = document.createElement('div');
            modal.className = 'custom-modal';
            modal.id = 'spatialQueryModal';
            modal.innerHTML = `
                <div class="modal-content" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; border: 2px solid #764ba2;">
                    <div style="color: white; padding: 30px; text-align: center;">
                        <h2 style="margin-bottom: 20px;"><i class="fas fa-mouse" style="color: #fff;"></i> Requ√™te Spatiale</h2>
                        <p style="font-size: 16px; margin-bottom: 15px;">üéØ <strong>Mode activ√© !</strong></p>
                        <p style="font-size: 14px; margin-bottom: 20px;">Cliquez sur la carte pour interroger les couches g√©ographiques. Les zones contenant votre point seront affich√©es.</p>
                        <div style="background: rgba(0,0,0,0.15); padding: 15px; border-radius: 6px; margin-bottom: 20px; text-align: left; font-size: 13px;">
                            <strong>üìç Instructions :</strong>
                            <ul style="margin: 10px 0 0 20px;">
                                <li>Cliquez sur une zone de la carte</li>
                                <li>Les propri√©t√©s des zones contenant le point s'afficheront</li>
                                <li>Cliquez √† nouveau pour interroger d'autres zones</li>
                                <li>Fermer ce modal pour quitter le mode</li>
                            </ul>
                        </div>
                        <button onclick="deactivateSpatialQuery(); document.getElementById('spatialQueryModal').remove();" style="background: white; color: #667eea; border: none; padding: 12px 24px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-right: 10px;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='white'">‚úÖ Fermer</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            setTimeout(() => {
                modal.classList.add('active');
            }, 10);
        }

        function deactivateSpatialQuery() {
            spatialQueryMode = false;
            map.dragging.enable();
            document.body.style.cursor = 'grab';
            map.off('click', performSpatialQuery);
        }

        function showSpatialQueryResults(results, point, foundLayers) {
            if (results.length === 0) {
                alert('‚ùå Aucune zone trouv√©e √† cette localisation.\n\nEssayez de cliquer sur une zone color√©e.');
                return;
            }

            // Zoom imm√©diat sur les r√©sultats trouv√©s
            var bounds = null;
            if (foundLayers && foundLayers.length > 0) {
                foundLayers.forEach(layer => {
                    // Surligner les zones trouv√©es
                    if (layer.setStyle) {
                        layer.setStyle({
                            weight: 3,
                            color: '#FF0000',
                            opacity: 1,
                            fillOpacity: 0.7,
                            dashArray: '5, 5'
                        });
                    }
                    
                    // Calculer les bounds
                    if (layer.getBounds) {
                        if (!bounds) {
                            bounds = layer.getBounds();
                        } else {
                            bounds.extend(layer.getBounds());
                        }
                    }
                });

                // Zoomer imm√©diatement
                if (bounds) {
                    map.fitBounds(bounds, { padding: [80, 80], maxZoom: 13, animate: true, duration: 0.8 });
                }
            }

            const modal = document.createElement('div');
            modal.className = 'custom-modal';
            modal.innerHTML = `
                <div class="modal-content" style="background: linear-gradient(135deg, #f0f8ff 0%, #e6f2ff 100%);">
                    <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <h2 class="modal-title" style="color: white; margin: 0;">üìä R√©sultats de la Requ√™te Spatiale</h2>
                        <button class="close-btn" onclick="this.closest('.custom-modal').remove(); resetQueryHighlight();" style="color: white; font-size: 28px; margin: 0;">&times;</button>
                    </div>
                    <div class="modal-body" style="color: #333;">
                        <p style="font-size: 13px; color: #666; margin-bottom: 15px;">
                            <strong>üìç Latitude :</strong> ${point.lat.toFixed(6)} | 
                            <strong>üìç Longitude :</strong> ${point.lng.toFixed(6)}
                        </p>
                        <p style="font-size: 12px; color: #fff; font-weight: bold; margin-bottom: 15px; background: linear-gradient(135deg, #27ae60 0%, #229954 100%); padding: 12px; border-radius: 6px; border-left: 4px solid #1e8449;">
                            <i class="fas fa-check-circle"></i> <strong>${results.length} zone(s) trouv√©e(s)</strong> - La carte a zoom√© automatiquement sur les r√©sultats
                        </p>
                        <div style="background: white; border-radius: 8px; overflow: hidden; border: 1px solid #ddd;">
                            ${results.map((result, index) => `
                                <div style="padding: 15px; border-bottom: ${index < results.length - 1 ? '1px solid #eee' : 'none'}; background: ${index % 2 === 0 ? '#f9f9f9' : 'white'};">
                                    <h4 style="color: #667eea; margin: 0 0 10px 0; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                                        <span style="display: inline-block; width: 12px; height: 12px; background: #FF0000; border-radius: 2px; border: 1px solid #999;"></span>
                                        ${result.type} : <strong>${result.name}</strong>
                                    </h4>
                                    <table style="width: 100%; font-size: 12px;">
                                        ${Object.entries(result.properties).map(([key, value]) => `
                                            <tr style="border-top: 1px solid #eee;">
                                                <td style="padding: 6px; font-weight: bold; color: #555; width: 40%;">${key}:</td>
                                                <td style="padding: 6px; color: #333;">${value || '-'}</td>
                                            </tr>
                                        `).join('')}
                                    </table>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            setTimeout(() => {
                modal.classList.add('active');
            }, 10);
        }

        // Fonction pour r√©initialiser le surlignage apr√®s fermeture
        var lastHighlightedLayers = [];
        function resetQueryHighlight() {
            lastHighlightedLayers.forEach(layer => {
                if (layer.setStyle) {
                    // Restaurer le style original
                    if (layer.feature && layer.feature.geometry.type === 'LineString' || layer.feature.geometry.type === 'MultiLineString') {
                        layer.setStyle({ opacity: 1 });
                    } else {
                        layer.setStyle({ opacity: 1, fillOpacity: 0.5 });
                    }
                }
            });
            lastHighlightedLayers = [];
        }

        // Requ√™te Attributaire
        function activateAttributeQuery() {
            showAttributeQueryModal();
        }

        function showAttributeQueryModal() {
            const modal = document.createElement('div');
            modal.className = 'custom-modal';
            modal.id = 'attributeQueryModal';
            modal.innerHTML = `
                <div class="modal-content" style="background: linear-gradient(135deg, #f0fdf4 0%, #f1fef5 100%); min-width: 600px;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%); color: white;">
                        <h2 class="modal-title" style="color: white; margin: 0;">üîç Requ√™te Attributaire</h2>
                        <button class="close-btn" onclick="this.closest('.custom-modal').remove();" style="color: white; font-size: 28px; margin: 0;">&times;</button>
                    </div>
                    <div class="modal-body" style="color: #333; padding: 25px;">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 10px; font-weight: bold; color: #27ae60;">
                                <i class="fas fa-layer-group"></i> S√©lectionnez une couche :
                            </label>
                            <select id="attrLayerSelect" style="width: 100%; padding: 10px; border: 1.5px solid #ddd; border-radius: 6px; font-size: 14px;">
                                <option value="">-- S√©lectionnez une couche --</option>
                                <option value="Region">R√©gions</option>
                                <option value="Departement">D√©partements</option>
                                <option value="Arrondissement">Arrondissements</option>
                                <option value="Routes">Routes</option>
                                <option value="Hydrographie">Hydrographie</option>
                                <option value="Localites">Localit√©s</option>
                            </select>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 10px; font-weight: bold; color: #27ae60;">
                                <i class="fas fa-search"></i> Crit√®re de recherche :
                            </label>
                            <input type="text" id="attrSearchValue" placeholder="Entrez la valeur √† rechercher..." style="width: 100%; padding: 10px; border: 1.5px solid #ddd; border-radius: 6px; font-size: 14px;">
                        </div>

                        <div id="attrResults" style="display: none; margin-top: 20px; max-height: 400px; overflow-y: auto; background: white; border-radius: 8px; padding: 15px; border: 1px solid #ddd;">
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button onclick="performAttributeQuery(); " style="flex: 1; background: linear-gradient(135deg, #27ae60 0%, #229954 100%); color: white; border: none; padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.3s;" onmouseover="this.style.background='linear-gradient(135deg, #229954 0%, #1e8449 100%)'" onmouseout="this.style.background='linear-gradient(135deg, #27ae60 0%, #229954 100%)'">
                                <i class="fas fa-search"></i> Rechercher
                            </button>
                            <button onclick="clearAttributeQuery();" style="flex: 1; background: #f0f0f0; color: #666; border: 1.5px solid #ddd; padding: 10px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.3s;" onmouseover="this.style.background='#e0e0e0'" onmouseout="this.style.background='#f0f0f0'">
                                <i class="fas fa-times"></i> Effacer
                            </button>
                            <button onclick="document.getElementById('attributeQueryModal').remove();" style="flex: 1; background: #ddd; color: #555; border: none; padding: 10px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.3s;" onmouseover="this.style.background='#ccc'" onmouseout="this.style.background='#ddd'">
                                <i class="fas fa-door-open"></i> Fermer
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            setTimeout(() => {
                modal.classList.add('active');
            }, 10);
        }

        function performAttributeQuery() {
            const layer = document.getElementById('attrLayerSelect').value;
            const searchValue = document.getElementById('attrSearchValue').value.toLowerCase();
            const resultsDiv = document.getElementById('attrResults');

            if (!layer || !searchValue) {
                alert('‚ö†Ô∏è Veuillez s√©lectionner une couche et entrer une valeur de recherche');
                return;
            }

            const results = [];
            const foundLayers = [];
            const layerMap = {
                'Region': { obj: window.layer_Region_2, property: 'R√©gion' },
                'Departement': { obj: window.layer_Departement_4, property: 'Dept' },
                'Arrondissement': { obj: window.layer_Arrondissement_3, property: 'dept' },
                'Routes': { obj: window.layer_Routes_5, property: 'LONGUEUR' },
                'Hydrographie': { obj: window.layer_Hydrographie_6, property: 'NOM' },
                'Localites': { obj: window.layer_localites_7, property: 'NOM' }
            };

            const layerInfo = layerMap[layer];
            if (!layerInfo || !layerInfo.obj) {
                alert('‚ùå Couche non trouv√©e');
                return;
            }

            layerInfo.obj.eachLayer(function(featureLayer) {
                if (featureLayer.feature && featureLayer.feature.properties) {
                    const props = featureLayer.feature.properties;
                    let matches = false;

                    // Chercher dans toutes les propri√©t√©s
                    for (let key in props) {
                        if (String(props[key]).toLowerCase().includes(searchValue)) {
                            matches = true;
                            break;
                        }
                    }

                    if (matches) {
                        results.push(featureLayer.feature.properties);
                        foundLayers.push(featureLayer);
                    }
                }
            });

            if (results.length === 0) {
                resultsDiv.style.display = 'none';
                alert(`‚ùå Aucun r√©sultat trouv√© pour "${searchValue}" dans "${layer}"`);
                return;
            }

            // Zoomer imm√©diatement sur les r√©sultats trouv√©s
            var bounds = null;
            foundLayers.forEach(featureLayer => {
                // Surligner les zones trouv√©es
                if (featureLayer.setStyle) {
                    featureLayer.setStyle({
                        weight: 3,
                        color: '#FF0000',
                        opacity: 1,
                        fillOpacity: 0.7,
                        dashArray: '5, 5'
                    });
                }
                
                if (featureLayer.getBounds) {
                    if (!bounds) {
                        bounds = featureLayer.getBounds();
                    } else {
                        bounds.extend(featureLayer.getBounds());
                    }
                }
            });

            if (bounds) {
                map.fitBounds(bounds, { padding: [80, 80], maxZoom: 13, animate: true, duration: 0.8 });
            }

            // Afficher les r√©sultats
            resultsDiv.innerHTML = `
                <p style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%); color: white; padding: 12px; border-radius: 6px; margin-top: 0; margin-bottom: 15px; font-size: 12px; font-weight: bold; border-left: 4px solid #1e8449;">
                    <i class="fas fa-check-circle"></i> <strong>${results.length} r√©sultat(s) trouv√©(s)</strong> - La carte a zoom√© automatiquement sur la section
                </p>
                <h4 style="color: #27ae60; margin-top: 0;">
                    <i class="fas fa-list"></i> D√©tails des r√©sultats :
                </h4>
                ${results.map((props, index) => `
                    <div style="background: ${index % 2 === 0 ? '#f9f9f9' : 'white'}; padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 4px solid #27ae60;">
                        <h5 style="margin: 0 0 10px 0; color: #27ae60; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                            <span style="display: inline-block; width: 12px; height: 12px; background: #FF0000; border-radius: 2px; border: 1px solid #999;"></span>
                            Entr√©e ${index + 1}
                        </h5>
                        <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                            ${Object.entries(props).map(([key, value]) => `
                                <tr style="border-top: 1px solid #eee;">
                                    <td style="padding: 6px; font-weight: bold; color: #555; width: 35%;">${key}</td>
                                    <td style="padding: 6px; color: #333;">${value || '-'}</td>
                                </tr>
                            `).join('')}
                        </table>
                    </div>
                `).join('')}
            `;
            resultsDiv.style.display = 'block';
            
            // Garder trace des couches surlighn√©es
            lastHighlightedLayers = foundLayers;
        }

        function clearAttributeQuery() {
            document.getElementById('attrLayerSelect').value = '';
            document.getElementById('attrSearchValue').value = '';
            document.getElementById('attrResults').style.display = 'none';
        }

        function downloadData() {
            showDownloadModal();
        }

        function showDownloadModal() {
            const modal = document.createElement('div');
            modal.className = 'custom-modal';
            modal.innerHTML = `
                <div class="modal-content" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); border-radius: 12px; border: 2px solid #229954; min-width: 400px;">
                    <div style="color: white; padding: 30px;">
                        <h2 style="margin-bottom: 20px;"><i class="fas fa-download" style="color: #fff;"></i> T√©l√©charger les Donn√©es</h2>
                        <p style="font-size: 14px; margin-bottom: 20px;">S√©lectionnez les couches √† t√©l√©charger :</p>
                        <div style="background: rgba(0,0,0,0.1); padding: 15px; border-radius: 6px; max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 10px; cursor: pointer;"><input type="checkbox" class="download-layer" value="Region" checked> R√©gions (GeoJSON)</label>
                            <label style="display: block; margin-bottom: 10px; cursor: pointer;"><input type="checkbox" class="download-layer" value="Departement" checked> D√©partements (GeoJSON)</label>
                            <label style="display: block; margin-bottom: 10px; cursor: pointer;"><input type="checkbox" class="download-layer" value="Arrondissement" checked> Arrondissements (GeoJSON)</label>
                            <label style="display: block; margin-bottom: 10px; cursor: pointer;"><input type="checkbox" class="download-layer" value="Routes" checked> Routes (GeoJSON)</label>
                            <label style="display: block; margin-bottom: 10px; cursor: pointer;"><input type="checkbox" class="download-layer" value="Hydrographie" checked> Hydrographie (GeoJSON)</label>
                            <label style="display: block; margin-bottom: 10px; cursor: pointer;"><input type="checkbox" class="download-layer" value="localites" checked> Localit√©s (GeoJSON)</label>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="downloadSelectedLayers(); document.querySelectorAll('.custom-modal').forEach(m => m.remove());" style="flex: 1; background: white; color: #27ae60; border: none; padding: 12px 24px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.3s;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='white'">üì• T√©l√©charger</button>
                            <button onclick="document.querySelectorAll('.custom-modal').forEach(m => m.remove());" style="flex: 1; background: rgba(255,255,255,0.3); color: white; border: 2px solid white; padding: 10px 24px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.5)'" onmouseout="this.style.background='rgba(255,255,255,0.3)'">Fermer</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            setTimeout(() => {
                modal.classList.add('active');
            }, 10);
        }

        // Download selected layers
        function downloadSelectedLayers() {
            const checked = Array.from(document.querySelectorAll('.download-layer:checked')).map(cb => cb.value);
            
            if (checked.length === 0) {
                alert('‚ùå Veuillez s√©lectionner au moins une couche');
                return;
            }

            checked.forEach(layerName => {
                let geoJsonData = null;
                let fileName = '';

                // Map layer names to data objects
                if (layerName === 'Region' && typeof data_Region_2 !== 'undefined') {
                    geoJsonData = data_Region_2;
                    fileName = 'Regions.geojson';
                } else if (layerName === 'Departement' && typeof data_Departement_4 !== 'undefined') {
                    geoJsonData = data_Departement_4;
                    fileName = 'Departements.geojson';
                } else if (layerName === 'Arrondissement' && typeof data_Arrondissement_3 !== 'undefined') {
                    geoJsonData = data_Arrondissement_3;
                    fileName = 'Arrondissements.geojson';
                } else if (layerName === 'Routes' && typeof data_Routes_5 !== 'undefined') {
                    geoJsonData = data_Routes_5;
                    fileName = 'Routes.geojson';
                } else if (layerName === 'Hydrographie' && typeof data_Hydrographie_6 !== 'undefined') {
                    geoJsonData = data_Hydrographie_6;
                    fileName = 'Hydrographie.geojson';
                } else if (layerName === 'localites' && typeof data_localites_7 !== 'undefined') {
                    geoJsonData = data_localites_7;
                    fileName = 'Localites.geojson';
                }

                if (geoJsonData) {
                    downloadGeoJSON(geoJsonData, fileName);
                }
            });

            alert(`‚úÖ ${checked.length} couche(s) t√©l√©charg√©e(s) avec succ√®s !`);
        }

        // Download GeoJSON file
        function downloadGeoJSON(geoJsonData, fileName) {
            const dataStr = JSON.stringify(geoJsonData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/geo+json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Legend data - avec ID pour les couches
        const legendData = [
            {name: 'R√©gions', color: 'rgb(211, 14, 30)', id: 'Region', layer: 'layer_Region_2'},
            {name: 'D√©partements', color: 'rgb(255, 158, 23)', id: 'Dept', layer: 'layer_Departement_4'},
            {name: 'Arrondissements', color: 'rgb(231, 113, 72)', id: 'Arr', layer: 'layer_Arrondissement_3'},
            {name: 'Routes', color: 'rgb(190, 178, 151)', id: 'Routes', layer: 'layer_Routes_5'},
            {name: 'Hydrographie', color: 'rgb(141, 90, 153)', id: 'Hydro', layer: 'layer_Hydrographie_6'},
            {name: 'Localit√©s', color: 'rgb(114, 155, 111)', id: 'Localites', layer: 'cluster_localites_7'}
        ];

        // Initialize legend with checkboxes
        function initializeLegend() {
            const legendContent = document.getElementById('legendContent');
            if (!legendContent) {
                console.warn('legendContent element not found');
                return;
            }

            // G√©n√©rer le HTML de la l√©gende (structure enrichie)
            let legendHTML = '';
            legendData.forEach(item => {
                legendHTML += `
                    <div class="legend-item" data-name="${item.name}" data-id="${item.id}" role="listitem">
                        <div class="legend-left">
                            <input type="checkbox" id="toggle-${item.id}" checked />
                            <div class="legend-symbol" style="background-color: ${item.color}; width: 16px; height: 16px; border-radius: 3px;"></div>
                        </div>
                        <div class="legend-main">
                            <label for="toggle-${item.id}">${item.name}</label>
                            <div class="legend-meta">√âl√©ments: <span class="legend-count">${getCountForLayer(item.layer)}</span></div>
                        </div>
                        <div class="legend-actions-item">
                            <button class="info-btn" title="Zoom sur la couche" data-id="${item.id}"><i class="fas fa-search-location"></i></button>
                        </div>
                    </div>
                `;
            });
            
            legendContent.innerHTML = legendHTML;
            console.debug('‚úì L√©gende charg√©e');
            
            // Ajouter les √©couteurs d'√©v√©nements
            setTimeout(() => {
                legendData.forEach(item => {
                    const checkbox = document.getElementById(`toggle-${item.id}`);
                    const infoBtn = document.querySelector(`.info-btn[data-id="${item.id}"]`);
                    const label = document.querySelector(`label[for="toggle-${item.id}"]`);

                    if (checkbox) {
                        // Retirer tout √©couteur existant
                        checkbox.removeEventListener('change', null);

                        // Ajouter le nouvel √©couteur
                        checkbox.addEventListener('change', function(e) {
                            const isChecked = this.checked;

                            try {
                                toggleLayerVisibility(item.id, item.layer, isChecked);
                            } catch(err) {
                                console.error(`Erreur pour ${item.id}:`, err.message);
                            }
                        });
                    }

                    if (label) {
                        label.addEventListener('click', function(){
                            if (checkbox) { checkbox.checked = !checkbox.checked; checkbox.dispatchEvent(new Event('change')); }
                        });
                    }

                    if (infoBtn) {
                        infoBtn.addEventListener('click', function(){
                            try {
                                const lyr = window[item.layer];
                                if (lyr && typeof lyr.getBounds === 'function') {
                                    map.fitBounds(lyr.getBounds());
                                } else if (lyr && typeof lyr.getLayers === 'function' && lyr.getLayers().length>0) {
                                    const first = lyr.getLayers()[0];
                                    if (first && first.getLatLng) map.setView(first.getLatLng(), 12);
                                } else {
                                    alert('Zoom non disponible pour cette couche');
                                }
                            } catch(e) {
                                console.warn('infoBtn error', e);
                            }
                        });
                    }
                });
                console.debug('‚úì Checkbox listeners attach√©s');
            }, 100);
        }

        // --- Legend enhancements: counts, filter, pin, collapse ---
        function getCountForLayer(layerVar) {
            try {
                const l = window[layerVar];
                if (!l) return '‚Äî';
                if (typeof l.getLayers === 'function') {
                    return l.getLayers().length;
                }
                // For GeoJSON-like objects
                if (Array.isArray(l.features)) return l.features.length;
                return '‚Äî';
            } catch (e) { return '‚Äî'; }
        }

        function updateLegendCounts(){
            legendData.forEach(item => {
                const container = document.querySelector(`.legend-item[data-id="${item.id}"]`);
                if (container) {
                    const countEl = container.querySelector('.legend-count');
                    if (countEl) countEl.textContent = getCountForLayer(item.layer);
                }
            });
        }

        function filterLegend(query){
            const q = (query || '').trim().toLowerCase();
            const items = document.querySelectorAll('#legendItems .legend-item');
            let visible = 0;
            items.forEach(it => {
                const name = (it.getAttribute('data-name') || '').toLowerCase();
                if (!q || name.indexOf(q) !== -1) { it.style.display='flex'; visible++; }
                else it.style.display='none';
            });
            document.getElementById('legendEmpty').style.display = (visible === 0 ? 'block' : 'none');
        }

        function attachLegendSearchListener(){
            const el = document.getElementById('legendSearch');
            if (!el) return;
            el.addEventListener('input', debounce(function(e){ filterLegend(e.target.value); }, 200));

            const pinBtn = document.getElementById('legendPinBtn');
            const collapseBtn = document.getElementById('legendCollapseBtn');
            if (pinBtn) pinBtn.addEventListener('click', function(){
                const sidebar = document.getElementById('sidebarRight');
                if (!sidebar) return;
                const isPinned = sidebar.classList.toggle('pinned');
                this.classList.toggle('active', isPinned);
                if (isPinned) {
                    sidebar.style.position = 'fixed';
                    sidebar.style.top = '70px';
                    sidebar.style.right = '10px';
                    sidebar.style.height = 'calc(100% - 140px)';
                    sidebar.style.boxShadow = '0 10px 30px rgba(12,74,26,0.12)';
                } else {
                    sidebar.style.position = '';
                    sidebar.style.top = '';
                    sidebar.style.right = '';
                    sidebar.style.height = '';
                    sidebar.style.boxShadow = '';
                }
            });

            if (collapseBtn) collapseBtn.addEventListener('click', function(){
                const items = document.getElementById('legendItems');
                if (!items) return;
                if (items.style.display === 'none') { items.style.display='block'; this.innerHTML = '<i class="fas fa-chevron-up"></i>'; }
                else { items.style.display = 'none'; this.innerHTML = '<i class="fas fa-chevron-down"></i>'; }
            });
        }

        // --- Main search enhancements (navbar search) ---
        function performSearch(query){
            const q = (query || '').trim().toLowerCase();
            const results = [];
            if (!q) return results;

            // Search legend layers
            legendData.forEach(item => {
                if (item.name.toLowerCase().indexOf(q) !== -1) {
                    results.push({type:'layer', name:item.name, id:item.id, layer:item.layer});
                }
            });

            // Search localities (if available)
            try {
                const cluster = window['cluster_localites_7'] || window['layer_localites_7'];
                if (cluster && typeof cluster.getLayers === 'function') {
                    const layers = cluster.getLayers();
                    for (let i=0;i<layers.length && results.length < 12;i++){
                        const lyr = layers[i];
                        const name = (lyr.feature && lyr.feature.properties && (lyr.feature.properties['NOM'] || lyr.feature.properties['name'] || ''));
                        if (name && name.toLowerCase().indexOf(q) !== -1) {
                            // Get latlng
                            let latlng = null;
                            if (typeof lyr.getLatLng === 'function') latlng = lyr.getLatLng();
                            else if (lyr.getBounds) latlng = lyr.getBounds().getCenter();
                            results.push({type:'locality', name: name, layer: lyr, latlng: latlng});
                        }
                    }
                }
            } catch(e){ console.warn('performSearch localities', e); }

            return results;
        }

        function renderSuggestions(results){
            const container = document.getElementById('searchSuggestions');
            container.innerHTML = '';
            if (!results || results.length === 0) { container.style.display = 'none'; return; }
            results.forEach(r => {
                const div = document.createElement('div');
                div.className = 'item';
                const type = document.createElement('span'); type.className='type'; type.textContent = r.type === 'locality' ? 'Localit√©' : 'Couche';
                const text = document.createElement('div'); text.style.flex = '1'; text.textContent = r.name;
                div.appendChild(type);
                div.appendChild(text);
                div.addEventListener('click', function(){ handleSuggestionClick(r); container.style.display='none'; });
                container.appendChild(div);
            });
            container.style.display = 'block';
        }

        function handleSuggestionClick(item){
            if (!item) return;
            if (item.type === 'locality'){
                if (item.latlng) {
                    map.setView([item.latlng.lat, item.latlng.lng], 15);
                    try { if (item.layer && typeof item.layer.openPopup === 'function') item.layer.openPopup(); } catch(e){}
                }
            } else if (item.type === 'layer'){
                // Ensure legend visible and checkbox checked
                switchTab(null, 'legend');
                const cb = document.getElementById(`toggle-${item.id}`);
                if (cb && !cb.checked) cb.checked = true, cb.dispatchEvent(new Event('change'));
                // Zoom to layer bounds if possible
                const lyr = window[item.layer];
                try {
                    if (lyr && typeof lyr.getBounds === 'function') {
                        map.fitBounds(lyr.getBounds());
                    } else if (lyr && typeof lyr.getLayers === 'function' && lyr.getLayers().length>0) {
                        const first = lyr.getLayers()[0];
                        if (first && first.getLatLng) map.setView(first.getLatLng(), 12);
                    }
                } catch(e){ console.warn('zoomToLayer error', e); }
            }
        }

        // Debounce helper
        function debounce(fn, delay){ let t; return function(){ const args = arguments; clearTimeout(t); t = setTimeout(()=> fn.apply(this, args), delay); }; }

        function enhanceMainSearch(){
            const input = document.getElementById('mainSearch');
            const sugg = document.getElementById('searchSuggestions');
            if (!input) return;
            input.addEventListener('input', debounce(function(e){ const res = performSearch(e.target.value); renderSuggestions(res); }, 220));
            input.addEventListener('blur', function(){ setTimeout(()=>{ if (sugg) sugg.style.display='none'; }, 250); });
            input.addEventListener('focus', function(){ const res = performSearch(input.value); renderSuggestions(res); });

            // keyboard navigation
            input.addEventListener('keydown', function(e){
                const items = document.querySelectorAll('#searchSuggestions .item');
                if(!items || items.length===0) return;
                let idx = Array.from(items).findIndex(i => i.classList.contains('active'));
                if (e.key === 'ArrowDown') { e.preventDefault(); if (idx < items.length-1) idx++; items.forEach(i=>i.classList.remove('active')); items[idx].classList.add('active'); }
                else if (e.key === 'ArrowUp') { e.preventDefault(); if (idx > 0) idx--; items.forEach(i=>i.classList.remove('active')); items[idx].classList.add('active'); }
                else if (e.key === 'Enter') { e.preventDefault(); const sel = document.querySelector('#searchSuggestions .item.active'); if (sel) sel.click(); }
            });
        }

        // Open quick legend on mobile
        const openLegendBtn = document.getElementById('openLegendBtn');
        if (openLegendBtn) {
            openLegendBtn.addEventListener('click', function(){
                if (window.innerWidth <= 768) {
                    const left = document.getElementById('sidebarLeft');
                    const right = document.getElementById('sidebarRight');
                    if (right && right.classList.contains('collapsed')) right.classList.remove('collapsed');
                    switchTab(null, 'legend');
                } else {
                    // desktop -> just open right sidebar
                    const right = document.getElementById('sidebarRight'); if (right && right.classList.contains('collapsed')) right.classList.remove('collapsed'); switchTab(null,'legend');
                }
            });
        }

        function setupLegendUI(){
            attachLegendSearchListener();
            updateLegendCounts();
            enhanceMainSearch();
            // render counts periodically to update dynamic layers
            setInterval(updateLegendCounts, 4000);
        }

        // Toggle layer visibility from legend
        function toggleLayerVisibility(layerId, layerVar, visible) {
            try {
                if (!map) {
                    console.error('Map non initialis√©e');
                    return;
                }

                const layer = window[layerVar];
                if (!layer) {
                    console.warn(`Couche ${layerVar} non trouv√©e`);
                    return;
                }

                if (visible) {
                    try {
                        if (!map.hasLayer(layer)) {
                            map.addLayer(layer);
                        }
                    } catch(e) {
                        console.error(`Erreur lors de l'ajout de ${layerId}:`, e.message);
                    }
                } else {
                    try {
                        if (map.hasLayer(layer)) {
                            map.removeLayer(layer);
                        }
                    } catch(e) {
                        console.error(`Erreur lors du retrait de ${layerId}:`, e.message);
                    }
                }
            } catch(e) {
                console.error(`Erreur g√©n√©rale toggleLayerVisibility ${layerId}:`, e.message);
            }
        }

        // Update coordinates on mouse move
        function updateCoordinates(e) {
            document.getElementById('lat').textContent = e.latlng.lat.toFixed(6);
            document.getElementById('lng').textContent = e.latlng.lng.toFixed(6);
        }

        // Calculate and update scale
        function updateScale() {
            const zoom = map.getZoom();
            const metersPerPixel = (40075017 * Math.cos(map.getCenter().lat * Math.PI / 180)) / (256 * Math.pow(2, zoom));
            const scale = Math.round(metersPerPixel * 96 * 39.37 / 12);
            document.getElementById('scaleInfo').textContent = `√âchelle: 1:${scale}`;
        }

        // Update coordinates on zoom
        function onZoomEnd() {
            document.getElementById('zoom').textContent = map.getZoom();
            updateScale();
        }

        // Initialize legend
        initializeLegend();
        setupLegendUI();

        // Initialize layers panel
        setTimeout(function() {
            initializeLayers();
        }, 300);

        var highlightLayer;
        function highlightFeature(e) {
            highlightLayer = e.target;
            if (e.target.feature.geometry.type === 'LineString' || e.target.feature.geometry.type === 'MultiLineString') {
              highlightLayer.setStyle({
                color: 'rgba(255, 255, 0, 1.00)',
              });
            } else {
              highlightLayer.setStyle({
                fillColor: 'rgba(255, 255, 0, 1.00)',
                fillOpacity: 1
              });
            }
            highlightLayer.openPopup();
        }
        
        var map = L.map('map', {
            zoomControl: false, maxZoom: 28, minZoom: 1
        }).fitBounds([[12.12546370303225,-18.87556500957226],[16.803451780511477,-9.859982997465725]]);
        
        // Add event listeners for coordinates
        map.on('mousemove', updateCoordinates);
        map.on('zoomend', onZoomEnd);
        
        // Initialize scale
        updateScale();

        var hash = new L.Hash(map);
        map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});

        if (window.initGeolocation) { try { window.initGeolocation(map); } catch(e) { console.warn('initGeolocation error', e); } }
        
        function removeEmptyRowsFromPopupContent(content, feature) {
         var tempDiv = document.createElement('div');
         tempDiv.innerHTML = content;
         var rows = tempDiv.querySelectorAll('tr');
         for (var i = 0; i < rows.length; i++) {
             var td = rows[i].querySelector('td.visible-with-data');
             var key = td ? td.id : '';
             if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                 rows[i].parentNode.removeChild(rows[i]);
             }
         }
         return tempDiv.innerHTML;
        }
        
        function addClassToPopupIfMedia(content, popup) {
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            var imgTd = tempDiv.querySelector('td img');
            if (imgTd) {
                var src = imgTd.getAttribute('src');
                if (/\.(jpg|jpeg|png|gif|bmp|webp|avif)$/i.test(src)) {
                    popup._contentNode.classList.add('media');
                    setTimeout(function() {
                        popup.update();
                    }, 10);
                } else if (/\.(mp3|wav|ogg|aac)$/i.test(src)) {
                    var audio = document.createElement('audio');
                    audio.controls = true;
                    audio.src = src;
                    imgTd.parentNode.replaceChild(audio, imgTd);
                    popup._contentNode.classList.add('media');
                    setTimeout(function() {
                        popup.setContent(tempDiv.innerHTML);
                        popup.update();
                    }, 10);
                } else if (/\.(mp4|webm|ogg|mov)$/i.test(src)) {
                    var video = document.createElement('video');
                    video.controls = true;
                    video.src = src;
                    video.style.width = "400px";
                    video.style.height = "300px";
                    video.style.maxHeight = "60vh";
                    video.style.maxWidth = "60vw";
                    imgTd.parentNode.replaceChild(video, imgTd);
                    popup._contentNode.classList.add('media');
                    video.addEventListener('loadedmetadata', function() {
                        popup.update();
                    });
                    setTimeout(function() {
                        popup.setContent(tempDiv.innerHTML);
                        popup.update();
                    }, 10);
                } else {
                    popup._contentNode.classList.remove('media');
                }
            } else {
                popup._contentNode.classList.remove('media');
            }
        }

        var bounds_group = new L.featureGroup([]);
        function setBounds() {
        }
        
        // Base maps setup
        map.createPane('pane_CartoDbDarkMatter_0');
        map.getPane('pane_CartoDbDarkMatter_0').style.zIndex = 400;
        var layer_CartoDbDarkMatter_0 = L.tileLayer('http://basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
            pane: 'pane_CartoDbDarkMatter_0',
            opacity: 1.0,
            attribution: '',
            minZoom: 1,
            maxZoom: 28,
            minNativeZoom: 0,
            maxNativeZoom: 20
        });
        map.addLayer(layer_CartoDbDarkMatter_0);
        
        // OpenStreetMap layer
        map.createPane('pane_OSM_1');
        map.getPane('pane_OSM_1').style.zIndex = 400;
        var layer_OSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            pane: 'pane_OSM_1',
            opacity: 1.0,
            attribution: '¬© OpenStreetMap contributors',
            minZoom: 1,
            maxZoom: 28,
            minNativeZoom: 0,
            maxNativeZoom: 19
        });
        
        map.createPane('pane_GoogleSatelliteHybrid_1');
        map.getPane('pane_GoogleSatelliteHybrid_1').style.zIndex = 401;
        var layer_GoogleSatelliteHybrid_1 = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
            pane: 'pane_GoogleSatelliteHybrid_1',
            opacity: 1.0,
            attribution: '',
            minZoom: 1,
            maxZoom: 28,
            minNativeZoom: 0,
            maxNativeZoom: 19
        });

        // ============ COUCHES G√âOGRAPHIQUES ============
        
        // Region Layer
        function pop_Region_2(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                    if (typeof layer.closePopup == 'function') {
                        layer.closePopup();
                    } else {
                        layer.eachLayer(function(feature){
                            feature.closePopup()
                        });
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table><tr><td colspan="2"><strong>Code</strong><br />' + (feature.properties['Code'] !== null ? autolinker.link(String(feature.properties['Code']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr><tr><td colspan="2"><strong>R√©gion</strong><br />' + (feature.properties['R√©gion'] !== null ? autolinker.link(String(feature.properties['R√©gion']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr></table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
            layer.on('popupopen', function(e) {
                addClassToPopupIfMedia(content, e.popup);
            });
            layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Region_2_0(feature) {
            switch(String(feature.properties['R√©gion'])) {
                case 'DAKAR':
                    return { pane: 'pane_Region_2', opacity: 1, color: 'rgba(35,35,35,1.0)', dashArray: '', lineCap: 'butt', lineJoin: 'miter', weight: 1.0, fill: true, fillOpacity: 1, fillColor: 'rgba(211,14,30,1.0)', interactive: true, };
                case 'DIOURBEL':
                    return { pane: 'pane_Region_2', opacity: 1, color: 'rgba(35,35,35,1.0)', dashArray: '', lineCap: 'butt', lineJoin: 'miter', weight: 1.0, fill: true, fillOpacity: 1, fillColor: 'rgba(145,235,137,1.0)', interactive: true, };
                case 'FATICK':
                    return { pane: 'pane_Region_2', opacity: 1, color: 'rgba(35,35,35,1.0)', dashArray: '', lineCap: 'butt', lineJoin: 'miter', weight: 1.0, fill: true, fillOpacity: 1, fillColor: 'rgba(107,163,220,1.0)', interactive: true, };
                case 'KAFFRINE':
                    return { pane: 'pane_Region_2', opacity: 1, color: 'rgba(35,35,35,1.0)', dashArray: '', lineCap: 'butt', lineJoin: 'miter', weight: 1.0, fill: true, fillOpacity: 1, fillColor: 'rgba(201,174,107,1.0)', interactive: true, };
                case 'KAOLACK':
                    return { pane: 'pane_Region_2', opacity: 1, color: 'rgba(35,35,35,1.0)', dashArray: '', lineCap: 'butt', lineJoin: 'miter', weight: 1.0, fill: true, fillOpacity: 1, fillColor: 'rgba(110,211,15,1.0)', interactive: true, };
                case 'KEDOUGOU':
                    return { pane: 'pane_Region_2', opacity: 1, color: 'rgba(35,35,35,1.0)', dashArray: '', lineCap: 'butt', lineJoin: 'miter', weight: 1.0, fill: true, fillOpacity: 1, fillColor: 'rgba(115,223,237,1.0)', interactive: true, };
                case 'KOLDA':
                    return { pane: 'pane_Region_2', opacity: 1, color: 'rgba(35,35,35,1.0)', dashArray: '', lineCap: 'butt', lineJoin: 'miter', weight: 1.0, fill: true, fillOpacity: 1, fillColor: 'rgba(31,204,86,1.0)', interactive: true, };
                case 'LOUGA':
                    return { pane: 'pane_Region_2', opacity: 1, color: 'rgba(35,35,35,1.0)', dashArray: '', lineCap: 'butt', lineJoin: 'miter', weight: 1.0, fill: true, fillOpacity: 1, fillColor: 'rgba(209,227,74,1.0)', interactive: true, };
                case 'MATAM':
                    return { pane: 'pane_Region_2', opacity: 1, color: 'rgba(35,35,35,1.0)', dashArray: '', lineCap: 'butt', lineJoin: 'miter', weight: 1.0, fill: true, fillOpacity: 1, fillColor: 'rgba(120,229,198,1.0)', interactive: true, };
                case 'SAINT-LOUIS':
                    return { pane: 'pane_Region_2', opacity: 1, color: 'rgba(35,35,35,1.0)', dashArray: '', lineCap: 'butt', lineJoin: 'miter', weight: 1.0, fill: true, fillOpacity: 1, fillColor: 'rgba(202,93,42,1.0)', interactive: true, };
                case 'SEDHIOU':
                    return { pane: 'pane_Region_2', opacity: 1, color: 'rgba(35,35,35,1.0)', dashArray: '', lineCap: 'butt', lineJoin: 'miter', weight: 1.0, fill: true, fillOpacity: 1, fillColor: 'rgba(151,112,235,1.0)', interactive: true, };
                case 'TAMBACOUNDA':
                    return { pane: 'pane_Region_2', opacity: 1, color: 'rgba(35,35,35,1.0)', dashArray: '', lineCap: 'butt', lineJoin: 'miter', weight: 1.0, fill: true, fillOpacity: 1, fillColor: 'rgba(200,107,237,1.0)', interactive: true, };
                case 'THIES':
                    return { pane: 'pane_Region_2', opacity: 1, color: 'rgba(35,35,35,1.0)', dashArray: '', lineCap: 'butt', lineJoin: 'miter', weight: 1.0, fill: true, fillOpacity: 1, fillColor: 'rgba(231,126,177,1.0)', interactive: true, };
                case 'ZIGUINCHOR':
                    return { pane: 'pane_Region_2', opacity: 1, color: 'rgba(35,35,35,1.0)', dashArray: '', lineCap: 'butt', lineJoin: 'miter', weight: 1.0, fill: true, fillOpacity: 1, fillColor: 'rgba(22,38,222,1.0)', interactive: true, };
            }
        }

        map.createPane('pane_Region_2');
        map.getPane('pane_Region_2').style.zIndex = 402;
        map.getPane('pane_Region_2').style['mix-blend-mode'] = 'normal';
        var layer_Region_2 = new L.geoJson(json_Region_2, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Region_2',
            layerName: 'layer_Region_2',
            pane: 'pane_Region_2',
            onEachFeature: pop_Region_2,
            style: style_Region_2_0,
        });
        bounds_group.addLayer(layer_Region_2);
        map.addLayer(layer_Region_2);

        // Arrondissement Layer
        function pop_Arrondissement_3(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                    if (typeof layer.closePopup == 'function') {
                        layer.closePopup();
                    } else {
                        layer.eachLayer(function(feature){
                            feature.closePopup()
                        });
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table><tr><td colspan="2"><strong>reg</strong><br />' + (feature.properties['reg'] !== null ? autolinker.link(String(feature.properties['reg']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr><tr><td colspan="2"><strong>dept</strong><br />' + (feature.properties['dept'] !== null ? autolinker.link(String(feature.properties['dept']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr></table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
            layer.on('popupopen', function(e) {
                addClassToPopupIfMedia(content, e.popup);
            });
            layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Arrondissement_3_0() {
            return { pane: 'pane_Arrondissement_3', opacity: 1, color: 'rgba(35,35,35,1.0)', dashArray: '', lineCap: 'butt', lineJoin: 'miter', weight: 1.0, fill: true, fillOpacity: 1, fillColor: 'rgba(231,113,72,1.0)', interactive: true, }
        }

        map.createPane('pane_Arrondissement_3');
        map.getPane('pane_Arrondissement_3').style.zIndex = 403;
        map.getPane('pane_Arrondissement_3').style['mix-blend-mode'] = 'normal';
        var layer_Arrondissement_3 = new L.geoJson(json_Arrondissement_3, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Arrondissement_3',
            layerName: 'layer_Arrondissement_3',
            pane: 'pane_Arrondissement_3',
            onEachFeature: pop_Arrondissement_3,
            style: style_Arrondissement_3_0,
        });
        bounds_group.addLayer(layer_Arrondissement_3);
        map.addLayer(layer_Arrondissement_3);

        // Departement Layer
        function pop_Departement_4(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                    if (typeof layer.closePopup == 'function') {
                        layer.closePopup();
                    } else {
                        layer.eachLayer(function(feature){
                            feature.closePopup()
                        });
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table><tr><td colspan="2"><strong>R√©gion</strong><br />' + (feature.properties['R√©gion'] !== null ? autolinker.link(String(feature.properties['R√©gion']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr><tr><td colspan="2"><strong>Dept</strong><br />' + (feature.properties['Dept'] !== null ? autolinker.link(String(feature.properties['Dept']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr></table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
            layer.on('popupopen', function(e) {
                addClassToPopupIfMedia(content, e.popup);
            });
            layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Departement_4_0() {
            return { pane: 'pane_Departement_4', opacity: 1, color: 'rgba(35,35,35,1.0)', dashArray: '', lineCap: 'butt', lineJoin: 'miter', weight: 1.0, fill: true, fillOpacity: 1, fillColor: 'rgba(255,158,23,1.0)', interactive: true, }
        }

        map.createPane('pane_Departement_4');
        map.getPane('pane_Departement_4').style.zIndex = 404;
        map.getPane('pane_Departement_4').style['mix-blend-mode'] = 'normal';
        var layer_Departement_4 = new L.geoJson(json_Departement_4, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Departement_4',
            layerName: 'layer_Departement_4',
            pane: 'pane_Departement_4',
            onEachFeature: pop_Departement_4,
            style: style_Departement_4_0,
        });
        bounds_group.addLayer(layer_Departement_4);
        map.addLayer(layer_Departement_4);

        // Routes Layer
        function pop_Routes_5(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                    if (typeof layer.closePopup == 'function') {
                        layer.closePopup();
                    } else {
                        layer.eachLayer(function(feature){
                            feature.closePopup()
                        });
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table><tr><td colspan="2"><strong>LONGUEUR</strong><br />' + (feature.properties['LONGUEUR'] !== null ? autolinker.link(String(feature.properties['LONGUEUR']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr></table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
            layer.on('popupopen', function(e) {
                addClassToPopupIfMedia(content, e.popup);
            });
            layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Routes_5_0() {
            return { pane: 'pane_Routes_5', opacity: 1, color: 'rgba(190,178,151,1.0)', dashArray: '', lineCap: 'square', lineJoin: 'bevel', weight: 1.0, fillOpacity: 0, interactive: true, }
        }

        map.createPane('pane_Routes_5');
        map.getPane('pane_Routes_5').style.zIndex = 405;
        map.getPane('pane_Routes_5').style['mix-blend-mode'] = 'normal';
        var layer_Routes_5 = new L.geoJson(json_Routes_5, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Routes_5',
            layerName: 'layer_Routes_5',
            pane: 'pane_Routes_5',
            onEachFeature: pop_Routes_5,
            style: style_Routes_5_0,
        });
        bounds_group.addLayer(layer_Routes_5);
        map.addLayer(layer_Routes_5);

        // Hydrographie Layer
        function pop_Hydrographie_6(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                    if (typeof layer.closePopup == 'function') {
                        layer.closePopup();
                    } else {
                        layer.eachLayer(function(feature){
                            feature.closePopup()
                        });
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table><tr><td colspan="2"><strong>NOM</strong><br />' + (feature.properties['NOM'] !== null ? autolinker.link(String(feature.properties['NOM']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr></table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
            layer.on('popupopen', function(e) {
                addClassToPopupIfMedia(content, e.popup);
            });
            layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Hydrographie_6_0() {
            return { pane: 'pane_Hydrographie_6', opacity: 1, color: 'rgba(141,90,153,1.0)', dashArray: '', lineCap: 'square', lineJoin: 'bevel', weight: 1.0, fillOpacity: 0, interactive: true, }
        }

        map.createPane('pane_Hydrographie_6');
        map.getPane('pane_Hydrographie_6').style.zIndex = 406;
        map.getPane('pane_Hydrographie_6').style['mix-blend-mode'] = 'normal';
        var layer_Hydrographie_6 = new L.geoJson(json_Hydrographie_6, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Hydrographie_6',
            layerName: 'layer_Hydrographie_6',
            pane: 'pane_Hydrographie_6',
            onEachFeature: pop_Hydrographie_6,
            style: style_Hydrographie_6_0,
        });
        bounds_group.addLayer(layer_Hydrographie_6);
        map.addLayer(layer_Hydrographie_6);

        // Localit√©s Layer with Clustering
        function pop_localites_7(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                    if (typeof layer.closePopup == 'function') {
                        layer.closePopup();
                    } else {
                        layer.eachLayer(function(feature){
                            feature.closePopup()
                        });
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table><tr><td colspan="2"><strong>NOM</strong><br />' + (feature.properties['NOM'] !== null ? autolinker.link(String(feature.properties['NOM']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr></table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
            layer.on('popupopen', function(e) {
                addClassToPopupIfMedia(content, e.popup);
            });
            layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_localites_7_0() {
            return { pane: 'pane_localites_7', radius: 4.0, opacity: 1, color: 'rgba(35,35,35,1.0)', dashArray: '', lineCap: 'butt', lineJoin: 'miter', weight: 1, fill: true, fillOpacity: 1, fillColor: 'rgba(114,155,111,1.0)', interactive: true, }
        }

        map.createPane('pane_localites_7');
        map.getPane('pane_localites_7').style.zIndex = 407;
        map.getPane('pane_localites_7').style['mix-blend-mode'] = 'normal';
        var layer_localites_7 = new L.geoJson(json_localites_7, {
            attribution: '',
            interactive: true,
            dataVar: 'json_localites_7',
            layerName: 'layer_localites_7',
            pane: 'pane_localites_7',
            onEachFeature: pop_localites_7,
            pointToLayer: function (feature, latlng) {
                return L.circleMarker(latlng, style_localites_7_0(feature));
            },
        });
        var cluster_localites_7 = new L.MarkerClusterGroup({showCoverageOnHover: false, spiderfyDistanceMultiplier: 2});
        cluster_localites_7.addLayer(layer_localites_7);
        bounds_group.addLayer(layer_localites_7);
        cluster_localites_7.addTo(map);

        // Cr√©er des alias pour le t√©l√©chargement
        var data_Region_2 = json_Region_2;
        var data_Departement_4 = json_Departement_4;
        var data_Arrondissement_3 = json_Arrondissement_3;
        var data_Routes_5 = json_Routes_5;
        var data_Hydrographie_6 = json_Hydrographie_6;
        var data_localites_7 = json_localites_7;

        // ========== FONCTION POUR REMPLIR LA FENETRE COUCHES ==========
        function initializeLayers() {
            const layersContainer = document.getElementById('layersContainer');
            if (!layersContainer) return;

            let html = '<div style="padding: 8px;">';
            
            // Section Couches G√©ographiques
            html += '<div style="margin-bottom: 15px;">';
            html += '<h4 style="color: #27ae60; font-size: 13px; margin: 0 0 8px 0; text-transform: uppercase; letter-spacing: 0.5px;"><i class="fas fa-map"></i> Couches G√©ographiques</h4>';
            
            const layers = [
                { id: 'toggle-Region', name: 'R√©gions', layer: layer_Region_2, color: 'rgb(211, 14, 30)' },
                { id: 'toggle-Dept', name: 'D√©partements', layer: layer_Departement_4, color: 'rgb(255, 158, 23)' },
                { id: 'toggle-Arr', name: 'Arrondissements', layer: layer_Arrondissement_3, color: 'rgb(231, 113, 72)' },
                { id: 'toggle-Routes', name: 'Routes', layer: layer_Routes_5, color: 'rgb(190, 178, 151)' },
                { id: 'toggle-Hydro', name: 'Hydrographie', layer: layer_Hydrographie_6, color: 'rgb(141, 90, 153)' },
                { id: 'toggle-Localites', name: 'Localit√©s', layer: cluster_localites_7, color: 'rgb(114, 155, 111)' }
            ];

            layers.forEach(layer => {
                const isVisible = map.hasLayer(layer.layer);
                html += `
                    <div class="legend-item" style="background: white; border: 1px solid #e0e0e0; padding: 10px 12px; margin-bottom: 8px; border-radius: 6px; transition: all 0.3s ease; cursor: pointer;">
                        <input type="checkbox" id="${layer.id}" ${isVisible ? 'checked' : ''} style="margin-right: 8px; cursor: pointer; accent-color: #27ae60;">
                        <div class="legend-symbol" style="background-color: ${layer.color}; width: 16px; height: 16px; border-radius: 2px; display: inline-block; margin-right: 8px; border: 1px solid #999;"></div>
                        <label for="${layer.id}" style="cursor: pointer; flex: 1; font-size: 13px; margin: 0;">${layer.name}</label>
                    </div>
                `;
            });

            html += '</div>';

            // Section Fonds de Carte
            html += '<div style="margin-bottom: 15px;">';
            html += '<h4 style="color: #27ae60; font-size: 13px; margin: 0 0 8px 0; text-transform: uppercase; letter-spacing: 0.5px;"><i class="fas fa-image"></i> Fonds de Carte</h4>';
            
            const basemaps = [
                { id: 'bm-cartodb', name: 'CartoDB Dark', layer: layer_CartoDbDarkMatter_0, group: 'basemap' },
                { id: 'bm-satellite', name: 'Google Satellite', layer: layer_GoogleSatelliteHybrid_1, group: 'basemap' },
                { id: 'bm-osm', name: 'OpenStreetMap', layer: layer_OSM, group: 'basemap' }
            ];

            basemaps.forEach(bm => {
                const isVisible = map.hasLayer(bm.layer);
                html += `
                    <div class="legend-item" style="background: white; border: 1px solid #e0e0e0; padding: 10px 12px; margin-bottom: 8px; border-radius: 6px; transition: all 0.3s ease; cursor: pointer;">
                        <input type="radio" name="basemap-layer" id="${bm.id}" ${isVisible ? 'checked' : ''} style="margin-right: 8px; cursor: pointer; accent-color: #27ae60;">
                        <label for="${bm.id}" style="cursor: pointer; flex: 1; font-size: 13px; margin: 0;">${bm.name}</label>
                    </div>
                `;
            });

            html += '</div>';

            html += '</div>';
            layersContainer.innerHTML = html;

            // Ajouter les √©v√©nements pour les couches g√©ographiques
            layers.forEach(layer => {
                const checkbox = document.getElementById(layer.id);
                if (checkbox) {
                    checkbox.addEventListener('change', function(e) {
                        const isChecked = this.checked;
                        if (isChecked) {
                            map.addLayer(layer.layer);
                        } else {
                            map.removeLayer(layer.layer);
                        }
                    });
                }
            });

            // Ajouter les √©v√©nements pour les fonds de carte
            basemaps.forEach(bm => {
                const radio = document.getElementById(bm.id);
                if (radio) {
                    radio.addEventListener('change', function(e) {
                        if (this.checked) {
                            basemaps.forEach(other => {
                                if (map.hasLayer(other.layer)) {
                                    map.removeLayer(other.layer);
                                }
                            });
                            map.addLayer(bm.layer);
                        }
                    });
                }
            });
        }

        // Layer tree for sidebar
        var overlaysTree = [
            {label: '<img src="legend/localites_7.png" /> Localit√©s', layer: cluster_localites_7},
            {label: '<img src="legend/Hydrographie_6.png" /> Hydrographie', layer: layer_Hydrographie_6},
            {label: '<img src="legend/Routes_5.png" /> Routes', layer: layer_Routes_5},
            {label: '<img src="legend/Departement_4.png" /> D√©partements', layer: layer_Departement_4},
            {label: '<img src="legend/Arrondissement_3.png" /> Arrondissements', layer: layer_Arrondissement_3},
            {label: '<img src="legend/Region_2_DAKAR0.png" /> R√©gions', layer: layer_Region_2},
            {label: "Google Satellite Hybrid", layer: layer_GoogleSatelliteHybrid_1, radioGroup: 'bm' },
            {label: "CartoDb Dark Matter", layer: layer_CartoDbDarkMatter_0, radioGroup: 'bm' },
            {label: "OpenStreetMap", layer: layer_OSM, radioGroup: 'bm' },
        ];
        var lay = L.control.layers.tree(null, overlaysTree, {
            collapsed: true,
        });
        
        // Place layers control in the left sidebar
        var layersContainer = document.getElementById('layersContainer');
        try {
            lay.addTo(map);
            if (lay._container) {
                layersContainer.appendChild(lay._container);
                lay._container.style.boxShadow = 'none';
                lay._container.style.border = 'none';
                lay._container.style.background = 'transparent';
                // Hide the default positioned control
                var defaultControl = document.querySelector('.leaflet-control-layers-tree');
                if (defaultControl && defaultControl.parentElement) {
                    defaultControl.parentElement.style.display = 'none';
                }
            }
        } catch(e) {
            console.warn('Layers control tree not available, using simplified version');
        }
        
        setBounds();

        // Add measure control
        var title = new L.Control({'position':'bottomright'});
        title.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'info');
            this.update();
            return this._div;
        };
        
        var zoomControl = L.control.zoom({
            position: 'bottomright'
        }).addTo(map);
        
        L.control.locate({locateOptions: {maxZoom: 19}, position: 'bottomright'}).addTo(map);
        
        var measureControl = new L.Control.Measure({
            position: 'bottomright',
            primaryLengthUnit: 'meters',
            secondaryLengthUnit: 'kilometers',
            primaryAreaUnit: 'sqmeters',
            secondaryAreaUnit: 'hectares'
        });
        measureControl.addTo(map);
        
        try {
            var measureToggle = document.getElementsByClassName('leaflet-control-measure-toggle');
            if (measureToggle.length > 0) {
                measureToggle[0].innerHTML = '';
                measureToggle[0].className += ' fas fa-ruler';
            }
        } catch(e) {
            console.warn('Measure control customization failed:', e);
        }

        // Variables pour le highlight
        var highlightedLayer = null;
        var originalStyle = null;

        // Fonction pour recherche rapide par couche
        function quickSearchLayer(searchTerm, layerName) {
            searchTerm = searchTerm.toLowerCase();
            var layer = window['layer_' + layerName];
            
            if (!layer) return;
            
            try {
                var propertyMap = {
                    'Region_2': 'R√©gion',
                    'Departement_4': 'Dept',
                    'Arrondissement_3': 'dept',
                    'Routes_5': 'LONGUEUR',
                    'Hydrographie_6': 'NOM',
                    'localites_7': 'NOM'
                };
                
                var property = propertyMap[layerName] || 'NOM';
                var foundLayers = [];
                
                layer.eachLayer(function(featureLayer) {
                    var value = (featureLayer.feature.properties[property] || '').toLowerCase();
                    if (value.includes(searchTerm)) {
                        featureLayer.setStyle({opacity: 1, fillOpacity: 0.7});
                        foundLayers.push(featureLayer);
                    } else if (searchTerm.length > 0) {
                        featureLayer.setStyle({opacity: 0.2, fillOpacity: 0.1});
                    } else {
                        // Restaurer le style original
                        if (layerName === 'Routes_5' || layerName === 'Hydrographie_6') {
                            featureLayer.setStyle({opacity: 1});
                        } else {
                            featureLayer.setStyle({opacity: 1, fillOpacity: 0.5});
                        }
                    }
                });
                
                // Zoomer sur la premi√®re correspondance trouv√©e
                if (foundLayers.length > 0 && searchTerm.length > 0) {
                    zoomAndHighlight(foundLayers[0]);
                }
            } catch(e) {
                console.debug('Erreur recherche rapide:', e);
            }
        }

        // Fonction pour effacer toutes les recherches
        function clearAllSearches() {
            document.getElementById('regionSearch').value = '';
            document.getElementById('departementSearch').value = '';
            document.getElementById('arrondissementSearch').value = '';
            document.getElementById('localiteSearch').value = '';
            document.getElementById('routeSearch').value = '';
            document.getElementById('hydrographieSearch').value = '';
            
            // R√©initialiser tous les filtres
            quickSearchLayer('', 'Region_2');
            quickSearchLayer('', 'Departement_4');
            quickSearchLayer('', 'Arrondissement_3');
            quickSearchLayer('', 'Routes_5');
            quickSearchLayer('', 'Hydrographie_6');
            quickSearchLayer('', 'localites_7');
        }

        // Fonction pour zoomer et highlighter une feature
        function zoomAndHighlight(layer) {
            try {
                // Retirer le highlight pr√©c√©dent
                if (highlightedLayer && originalStyle) {
                    highlightedLayer.setStyle(originalStyle);
                }
                
                // Ajouter le highlight rouge au nouveau layer
                if (layer.setStyle) {
                    originalStyle = {
                        color: layer.options.color,
                        weight: layer.options.weight,
                        opacity: layer.options.opacity,
                        fillOpacity: layer.options.fillOpacity,
                        fillColor: layer.options.fillColor
                    };
                    
                    // Style rouge pour le highlight
                    layer.setStyle({
                        color: '#ff0000',
                        weight: 3,
                        opacity: 1,
                        fillOpacity: layer.options.fillOpacity || 0.5
                    });
                    
                    highlightedLayer = layer;
                }
                
                // Zoomer sur la feature
                if (layer.getBounds) {
                    map.fitBounds(layer.getBounds(), { padding: [50, 50] });
                }
            } catch(e) {
                console.debug('Erreur zoom/highlight:', e);
            }
        }

        // Fonction pour filtrer les couches
        function filterLayers(searchTerm) {
            searchTerm = searchTerm.toLowerCase();
            
            try {
                // Filtrer R√©gions
                if (window.layer_Region_2) {
                    window.layer_Region_2.eachLayer(function(layer) {
                        var nom = (layer.feature.properties['R√©gion'] || '').toLowerCase();
                        if (nom.includes(searchTerm)) {
                            layer.setStyle({opacity: 1, fillOpacity: 0.7});
                        } else if (searchTerm.length > 0) {
                            layer.setStyle({opacity: 0.2, fillOpacity: 0.1});
                        } else {
                            layer.setStyle({opacity: 1, fillOpacity: 0.5});
                        }
                    });
                }
                
                // Filtrer Arrondissements
                if (window.layer_Arrondissement_3) {
                    window.layer_Arrondissement_3.eachLayer(function(layer) {
                        var nom = (layer.feature.properties['dept'] || '').toLowerCase();
                        if (nom.includes(searchTerm)) {
                            layer.setStyle({opacity: 1, fillOpacity: 0.7});
                        } else if (searchTerm.length > 0) {
                            layer.setStyle({opacity: 0.2, fillOpacity: 0.1});
                        } else {
                            layer.setStyle({opacity: 1, fillOpacity: 0.5});
                        }
                    });
                }
                
                // Filtrer D√©partements
                if (window.layer_Departement_4) {
                    window.layer_Departement_4.eachLayer(function(layer) {
                        var nom = (layer.feature.properties['Dept'] || '').toLowerCase();
                        if (nom.includes(searchTerm)) {
                            layer.setStyle({opacity: 1, fillOpacity: 0.7});
                        } else if (searchTerm.length > 0) {
                            layer.setStyle({opacity: 0.2, fillOpacity: 0.1});
                        } else {
                            layer.setStyle({opacity: 1, fillOpacity: 0.5});
                        }
                    });
                }
                
                // Filtrer Routes
                if (window.layer_Routes_5) {
                    window.layer_Routes_5.eachLayer(function(layer) {
                        var nom = (layer.feature.properties['LONGUEUR'] || '').toLowerCase();
                        if (nom.includes(searchTerm)) {
                            layer.setStyle({opacity: 1});
                        } else if (searchTerm.length > 0) {
                            layer.setStyle({opacity: 0.1});
                        } else {
                            layer.setStyle({opacity: 1});
                        }
                    });
                }
                
                // Filtrer Hydrographie
                if (window.layer_Hydrographie_6) {
                    window.layer_Hydrographie_6.eachLayer(function(layer) {
                        var nom = (layer.feature.properties['NOM'] || '').toLowerCase();
                        if (nom.includes(searchTerm)) {
                            layer.setStyle({opacity: 1});
                        } else if (searchTerm.length > 0) {
                            layer.setStyle({opacity: 0.1});
                        } else {
                            layer.setStyle({opacity: 1});
                        }
                    });
                }
            } catch(e) {
                console.debug('Erreur filtrage couches:', e);
            }
        }
        

        // Cr√©er un contr√¥le Leaflet pour les recherches rapides
        L.Control.QuickSearch = L.Control.extend({
            options: {
                position: 'topleft'
            },

            onAdd: function(map) {
                var self = this;
                var container = L.DomUtil.create('div', 'leaflet-control leaflet-control-quicksearch');
                
                var wrapper = L.DomUtil.create('div', 'quicksearch-container', container);
                
                var toggleBtn = L.DomUtil.create('button', 'quicksearch-toggle-icon', wrapper);
                toggleBtn.innerHTML = '<i class="fas fa-glasses"></i>';
                toggleBtn.title = 'Recherche rapide';
                
                var dropdown = L.DomUtil.create('div', 'quicksearch-dropdown', wrapper);
                
                var header = L.DomUtil.create('div', 'quicksearch-header', dropdown);
                header.innerHTML = '<i class="fas fa-search"></i> Recherche Rapide';
                
                var inputs = L.DomUtil.create('div', 'quicksearch-inputs', dropdown);
                inputs.innerHTML = `
                    <input type="text" id="qs-region" class="quicksearch-input" placeholder="R√©gion..." autocomplete="off">
                    <input type="text" id="qs-dept" class="quicksearch-input" placeholder="D√©partement..." autocomplete="off">
                    <input type="text" id="qs-arrond" class="quicksearch-input" placeholder="Arrondissement..." autocomplete="off">
                    <input type="text" id="qs-localite" class="quicksearch-input" placeholder="Localit√©..." autocomplete="off">
                    <input type="text" id="qs-route" class="quicksearch-input" placeholder="Route..." autocomplete="off">
                    <input type="text" id="qs-hydro" class="quicksearch-input" placeholder="Hydrographie..." autocomplete="off">
                `;
                
                var buttons = L.DomUtil.create('div', 'quicksearch-buttons', dropdown);
                buttons.innerHTML = `
                    <button class="quicksearch-btn quicksearch-search-btn" onclick="performQuickSearch()">
                        <i class="fas fa-search"></i> Chercher
                    </button>
                    <button class="quicksearch-btn quicksearch-clear-btn" onclick="clearQuickSearch()">
                        <i class="fas fa-times"></i> Effacer
                    </button>
                `;
                
                // Toggle dropdown
                L.DomEvent.on(toggleBtn, 'click', function(e) {
                    L.DomEvent.stopPropagation(e);
                    dropdown.classList.toggle('active');
                    if (dropdown.classList.contains('active')) {
                        setTimeout(() => document.getElementById('qs-region').focus(), 100);
                    }
                });
                
                // Close dropdown when clicking outside
                L.DomEvent.on(document, 'click', function(e) {
                    if (!wrapper.contains(e.target) && dropdown.classList.contains('active')) {
                        dropdown.classList.remove('active');
                    }
                });
                
                L.DomEvent.disableClickPropagation(wrapper);
                L.DomEvent.disableScrollPropagation(wrapper);

                return container;
            }
        });

        // Ajouter le contr√¥le √† la carte
        map.addControl(new L.Control.QuickSearch({ position: 'topleft' }));

        // Smart Search Control - Autocomplete avec suggestions
        L.Control.SmartSearch = L.Control.extend({
            options: {
                position: 'topleft'
            },

            onAdd: function(map) {
                var self = this;
                var container = L.DomUtil.create('div', 'leaflet-control leaflet-control-smartsearch');
                
                var toggleBtn = L.DomUtil.create('button', 'smartsearch-toggle', container);
                toggleBtn.innerHTML = '<i class="fas fa-search"></i>';
                toggleBtn.title = 'Recherche intelligente';

                var panel = L.DomUtil.create('div', 'smartsearch-panel', container);
                
                var searchDiv = L.DomUtil.create('div', 'smartsearch-search', panel);
                var searchIcon = L.DomUtil.create('i', 'fas fa-search', searchDiv);
                var searchInput = L.DomUtil.create('input', '', searchDiv);
                searchInput.type = 'text';
                searchInput.placeholder = 'R√©gion, D√©partement...';
                searchInput.autocomplete = 'off';
                var clearIcon = L.DomUtil.create('div', 'smartsearch-clear-icon', searchDiv);
                clearIcon.innerHTML = '<i class="fas fa-times"></i>';

                var resultsDiv = L.DomUtil.create('div', 'smartsearch-results', panel);

                // Toggle panel visibility
                L.DomEvent.on(toggleBtn, 'click', function() {
                    panel.classList.toggle('active');
                    if (panel.classList.contains('active')) {
                        setTimeout(() => searchInput.focus(), 100);
                    }
                });

                // Smart search functionality
                var allResults = [];
                
                L.DomEvent.on(searchInput, 'input', function() {
                    var term = searchInput.value.toLowerCase().trim();
                    resultsDiv.innerHTML = '';
                    
                    if (term.length === 0) {
                        clearIcon.classList.remove('show');
                        resultsDiv.innerHTML = '';
                        return;
                    }

                    clearIcon.classList.add('show');
                    allResults = [];

                    // Search in R√©gions
                    if (window.layer_Region_2) {
                        window.layer_Region_2.eachLayer(function(layer) {
                            if (layer.feature && layer.feature.properties && layer.feature.properties.R√©gion) {
                                var name = layer.feature.properties.R√©gion;
                                if (name.toLowerCase().includes(term)) {
                                    allResults.push({
                                        name: name,
                                        type: 'region',
                                        layer: layer,
                                        property: 'R√©gion'
                                    });
                                }
                            }
                        });
                    }

                    // Search in D√©partements
                    if (window.layer_Departement_4) {
                        window.layer_Departement_4.eachLayer(function(layer) {
                            if (layer.feature && layer.feature.properties && layer.feature.properties.Dept) {
                                var name = layer.feature.properties.Dept;
                                if (name.toLowerCase().includes(term)) {
                                    allResults.push({
                                        name: name,
                                        type: 'departement',
                                        layer: layer,
                                        property: 'Dept'
                                    });
                                }
                            }
                        });
                    }

                    // Search in Arrondissements
                    if (window.layer_Arrondissement_3) {
                        window.layer_Arrondissement_3.eachLayer(function(layer) {
                            if (layer.feature && layer.feature.properties && layer.feature.properties.dept) {
                                var name = layer.feature.properties.dept;
                                if (name.toLowerCase().includes(term)) {
                                    allResults.push({
                                        name: name,
                                        type: 'arrondissement',
                                        layer: layer,
                                        property: 'dept'
                                    });
                                }
                            }
                        });
                    }

                    // Search in Localit√©s
                    if (window.layer_localites_7) {
                        window.layer_localites_7.eachLayer(function(layer) {
                            if (layer.feature && layer.feature.properties && layer.feature.properties.NOM) {
                                var name = layer.feature.properties.NOM;
                                if (name.toLowerCase().includes(term)) {
                                    allResults.push({
                                        name: name,
                                        type: 'localite',
                                        layer: layer,
                                        property: 'NOM'
                                    });
                                }
                            }
                        });
                    }

                    // Limit results and display
                    var limitedResults = allResults.slice(0, 20);
                    
                    if (limitedResults.length === 0) {
                        resultsDiv.innerHTML = '<div class="smartsearch-no-results">Aucun r√©sultat trouv√©</div>';
                        return;
                    }

                    limitedResults.forEach(function(result) {
                        var item = L.DomUtil.create('div', 'smartsearch-result-item ' + result.type, resultsDiv);
                        item.textContent = result.name;
                        
                        L.DomEvent.on(item, 'click', function() {
                            // Reset all layers first
                            filterLayers('');
                            
                            // Highlight and zoom to selected feature
                            if (result.layer) {
                                zoomAndHighlight(result.layer);
                            }
                            
                            // Close panel and clear search
                            searchInput.value = '';
                            clearIcon.classList.remove('show');
                            resultsDiv.innerHTML = '';
                            setTimeout(() => panel.classList.remove('active'), 200);
                        });
                    });
                });

                // Clear search
                L.DomEvent.on(clearIcon, 'click', function() {
                    searchInput.value = '';
                    clearIcon.classList.remove('show');
                    resultsDiv.innerHTML = '';
                    searchInput.focus();
                });

                L.DomEvent.disableClickPropagation(container);
                L.DomEvent.disableScrollPropagation(container);

                return container;
            }
        });

        // Ajouter le contr√¥le Smart Search √† la carte
        map.addControl(new L.Control.SmartSearch({ position: 'topleft' }));

        // Fonction pour effectuer la recherche rapide
        window.performQuickSearch = function() {
            var searches = {
                'Region_2': document.getElementById('qs-region').value,
                'Departement_4': document.getElementById('qs-dept').value,
                'Arrondissement_3': document.getElementById('qs-arrond').value,
                'localites_7': document.getElementById('qs-localite').value,
                'Routes_5': document.getElementById('qs-route').value,
                'Hydrographie_6': document.getElementById('qs-hydro').value
            };
            
            for (var layer in searches) {
                if (searches[layer].length > 0) {
                    quickSearchLayer(searches[layer], layer);
                }
            }
        };

        // Fonction pour effacer les recherches
        window.clearQuickSearch = function() {
            document.getElementById('qs-region').value = '';
            document.getElementById('qs-dept').value = '';
            document.getElementById('qs-arrond').value = '';
            document.getElementById('qs-localite').value = '';
            document.getElementById('qs-route').value = '';
            document.getElementById('qs-hydro').value = '';
            
            // R√©initialiser tous les filtres
            filterLayers('');
        };

        // Ajouter √©v√©nement pour recherche en temps r√©el
        setTimeout(function() {
            ['qs-region', 'qs-dept', 'qs-arrond', 'qs-localite', 'qs-route', 'qs-hydro'].forEach(function(id) {
                var input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', function(e) {
                        performQuickSearch();
                    });
                }
            });
        }, 500);
        
        setTimeout(function() {
            try {
                const url = {"Nominatim OSM": "https://nominatim.openstreetmap.org/search?format=geojson&addressdetails=1&"};
                var photonControl = L.control.photon({
                    url: url["Nominatim OSM"],
                    feedbackLabel: '',
                    position: 'topleft',
                    includePosition: true,
                    initial: true,
                });
                
                if (photonControl._container) {
                    var photonContainer = document.getElementById('photonContainer');
                    if (photonContainer) {
                        photonControl._container.style.position = "relative";
                        photonControl._container.style.top = "auto";
                        photonControl._container.style.left = "auto";
                        photonControl._container.style.right = "auto";
                        photonControl._container.style.width = "100%";
                        photonControl._container.style.zIndex = "auto";
                        photonControl._container.style.margin = "0";
                        photonControl._container.style.boxShadow = "none";
                        photonControl._container.style.border = "none";
                        photonControl._container.style.borderRadius = "0";
                        
                        // Add placeholder to input
                        var photonInput = photonControl._container.querySelector('input');
                        if (photonInput) {
                            photonInput.placeholder = 'üåç Adresse, rue, lieu...';
                            photonInput.setAttribute('aria-label', 'Rechercher par adresse ou lieu');
                            
                            // Ajouter filtrage en temps r√©el
                            photonInput.addEventListener('input', function(e) {
                                filterLayers(e.target.value);
                            });
                            
                            // R√©initialiser le filtre au clear
                            photonInput.addEventListener('change', function(e) {
                                if (!e.target.value) {
                                    filterLayers('');
                                }
                            });
                        }
                        
                        // Ajouter √©v√©nement de s√©lection de r√©sultat
                        photonControl.on('photonresult', function(result) {
                            if (result.latlng) {
                                map.setView(result.latlng, 14);
                                // Chercher et highlighter la couche correspondante
                                var searchTerm = (result.properties.name || '').toLowerCase();
                                filterLayers(searchTerm);
                            }
                        });
                        
                        if (photonControl._container.childNodes[0]) {
                            photonControl._container.childNodes[0].style.borderRadius = "8px";
                        }
                        photonContainer.appendChild(photonControl._container);
                    } else {
                        photonControl.addTo(map);
                    }
                }
            } catch(e) {
                console.warn('Photon control not available:', e);
            }
        }, 300);

        // Add labels with error handling - delayed to ensure layers are fully loaded
        setTimeout(function() {
            try {
                if (typeof labels !== 'undefined' && typeof totalMarkers !== 'undefined' && typeof addLabel !== 'undefined') {
                    try {
                        if (layer_Region_2 && typeof layer_Region_2.eachLayer === 'function') {
                            var i = 0;
                            layer_Region_2.eachLayer(function(layer) {
                                try {
                                    if (layer && layer.feature && layer.feature.properties) {
                                        var tooltipText = layer.feature.properties['R√©gion'] || '';
                                        if (tooltipText) {
                                            layer.bindTooltip('<div style="color: #000; font-size: 12pt; font-weight: bold; text-shadow: 1px 1px 2px white, -1px -1px 2px white, 1px -1px 2px white, -1px 1px 2px white; background: rgba(255,255,255,0.7); padding: 4px 8px; border-radius: 4px;">' + tooltipText + '</div>', {
                                                permanent: true, 
                                                offset: [0, -16], 
                                                className: 'css_Region_2',
                                                direction: 'top'
                                            });
                                        }
                                    }
                                } catch(err) {
                                    console.debug('Erreur tooltip Region:', err.message);
                                }
                                i++;
                            });
                        }
                    } catch(e) {
                        console.debug('Pas de labels disponibles pour R√©gions');
                    }

                    try {
                        if (layer_Arrondissement_3 && typeof layer_Arrondissement_3.eachLayer === 'function') {
                            var i = 0;
                            layer_Arrondissement_3.eachLayer(function(layer) {
                                try {
                                    if (layer && layer.feature && layer.feature.properties) {
                                        var tooltipText = layer.feature.properties['dept'] || '';
                                        if (tooltipText) {
                                            layer.bindTooltip('<div style="color: #000; font-size: 12pt; font-weight: bold; text-shadow: 1px 1px 2px white, -1px -1px 2px white, 1px -1px 2px white, -1px 1px 2px white; background: rgba(255,255,255,0.7); padding: 4px 8px; border-radius: 4px;">' + tooltipText + '</div>', {
                                                permanent: true, 
                                                offset: [0, -16], 
                                                className: 'css_Arrondissement_3',
                                                direction: 'top'
                                            });
                                        }
                                    }
                                } catch(err) {
                                    console.debug('Erreur tooltip Arrondissement:', err.message);
                                }
                                i++;
                            });
                        }
                    } catch(e) {
                        console.debug('Pas de labels disponibles pour Arrondissements');
                    }
                }
            } catch(e) {
                console.debug('Label system not available:', e.message);
            }
        }, 500);

        // Search control with error handling - moved to sidebar
        setTimeout(function() {
            try {
                var searchControl = new L.Control.Search({
                    layer: cluster_localites_7,
                    initial: false,
                    hideMarkerOnCollapse: true,
                    propertyName: 'NOM'});
                
                var localitiesContainer = document.getElementById('localitiesSearchContainer');
                if (localitiesContainer) {
                    searchControl.addTo(map);
                    // Move the search control to the custom container
                    var searchControlElement = document.querySelector('.leaflet-control-search');
                    if (searchControlElement) {
                        searchControlElement.style.position = "relative";
                        searchControlElement.style.top = "auto";
                        searchControlElement.style.left = "auto";
                        searchControlElement.style.right = "auto";
                        searchControlElement.style.width = "100%";
                        searchControlElement.style.zIndex = "auto";
                        searchControlElement.style.margin = "0";
                        searchControlElement.style.boxShadow = "none";
                        searchControlElement.style.border = "none";
                        searchControlElement.style.borderRadius = "0";
                        
                        // Add placeholder to search input
                        var searchInput = searchControlElement.querySelector('input');
                        if (searchInput) {
                            searchInput.placeholder = 'üìç Localit√©, ville, village...';
                            searchInput.setAttribute('aria-label', 'Rechercher une localit√©');
                            
                            // Ajouter √©v√©nement de recherche
                            searchInput.addEventListener('input', function(e) {
                                var searchTerm = e.target.value.toLowerCase();
                                // Filtrer les localit√©s
                                if (window.layer_localites_7) {
                                    window.layer_localites_7.eachLayer(function(layer) {
                                        var nom = (layer.feature.properties['NOM'] || '').toLowerCase();
                                        if (nom.includes(searchTerm) && searchTerm.length > 0) {
                                            layer.setStyle({opacity: 1, fillOpacity: 1});
                                        } else if (searchTerm.length > 0) {
                                            layer.setStyle({opacity: 0.1, fillOpacity: 0.1});
                                        } else {
                                            layer.setStyle({opacity: 1, fillOpacity: 1});
                                        }
                                    });
                                }
                            });
                        }
                        
                        localitiesContainer.appendChild(searchControlElement);
                    }
                } else {
                    searchControl.addTo(map);
                }

                var searchBtns = document.getElementsByClassName('search-button');
                if (searchBtns.length > 0) {
                    searchBtns[searchBtns.length - 1].className += ' fa fa-binoculars';
                }
                
                // Ajouter √©v√©nement pour zoomer/highlight au clic sur r√©sultat
                map.on('geosearch/showlocation', function(e) {
                    var layer = e.location.layer;
                    if (layer) {
                        zoomAndHighlight(layer);
                    }
                });
            } catch(e) {
                console.warn('Search control not available:', e);
            }
        }, 300);

        // Si le document est d√©j√† charg√©
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(function() {
                    showModal('accueil');
                }, 1000);
            });
        } else {
            setTimeout(function() {
                showModal('accueil');
            }, 1500);
        }
        </script>

        <script src="js/geolocation.js"></script>
        <script>
        // Service worker registration
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', function() {
            navigator.serviceWorker.register('/sw.js').then(function(reg) {
              console.log('Service worker registered.', reg);
            }).catch(function(err) {
              console.warn('Service worker registration failed:', err);
            });
          });
        }

        // Installation prompt handling
        let deferredPrompt;
        const installBtn = document.getElementById('install-btn');
        function promptInstall() {
          if (!deferredPrompt) return;
          deferredPrompt.prompt();
          deferredPrompt.userChoice.then(function(choiceResult){
            deferredPrompt = null;
            installBtn.style.display = 'none';
          });
        }
        window.addEventListener('beforeinstallprompt', (e) => {
          e.preventDefault();
          deferredPrompt = e;
          if (installBtn) installBtn.style.display = 'inline-flex';
          console.log('beforeinstallprompt fired');
        });
        window.addEventListener('appinstalled', (evt) => {
          console.log('App installed');
          if (installBtn) installBtn.style.display = 'none';
        });

        // Mobile menu toggling and responsive adjustments
        function toggleMobileMenu(){
          const menu = document.getElementById('navbarMenu');
          const btnClose = document.getElementById('mobile-menu-close');
          if(!menu) return;
          if(menu.classList.contains('mobile-open')){
            menu.classList.remove('mobile-open');
            document.body.classList.remove('mobile-menu-open');
            if(btnClose) btnClose.style.display = 'none';
            menu.setAttribute('aria-hidden','true');
          } else {
            menu.classList.add('mobile-open');
            document.body.classList.add('mobile-menu-open');
            if(btnClose) btnClose.style.display = 'inline-flex';
            menu.setAttribute('aria-hidden','false');
          }
        }

        function adjustForScreenSize() {
          const left = document.getElementById('sidebarLeft');
          const right = document.getElementById('sidebarRight');
          if (window.innerWidth <= 768) {
            if (left && !left.classList.contains('collapsed')) left.classList.add('collapsed');
            if (right && !right.classList.contains('collapsed')) right.classList.add('collapsed');
            const install = document.getElementById('install-btn');
            if (install) install.style.display = 'inline-flex';
          } else {
            if (left && left.classList.contains('collapsed')) left.classList.remove('collapsed');
            if (right && right.classList.contains('collapsed')) right.classList.remove('collapsed');
            const install = document.getElementById('install-btn');
            if (install) install.style.display = 'none';
          }
          if (window.map && typeof window.map.invalidateSize === 'function') {
            setTimeout(function(){ window.map.invalidateSize(); }, 350);
          }
        }

        window.addEventListener('load', adjustForScreenSize);
        window.addEventListener('resize', adjustForScreenSize);
        document.addEventListener('click', function(e){
          const menu = document.getElementById('navbarMenu');
          const btn = document.getElementById('mobile-menu-btn');
          if(menu && btn && menu.classList.contains('mobile-open') && !menu.contains(e.target) && !btn.contains(e.target)){
            menu.classList.remove('mobile-open');
          }
        });
        </script>
    </body>
</html>